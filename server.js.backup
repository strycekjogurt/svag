import express from 'express';
import cors from 'cors';
import { createClient } from '@supabase/supabase-js';
import Stripe from 'stripe';
import pako from 'pako';
import dotenv from 'dotenv';

dotenv.config();

const app = express();

// CORS konfigurace - povolit v≈°echny originy (pro Chrome extension)
app.use(cors({
  origin: '*',
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: false
}));

app.use(express.json({ limit: '10mb' }));

// Raw body pro Stripe webhooks
app.use('/api/webhooks/stripe', express.raw({ type: 'application/json' }));

// EJS template engine
app.set('view engine', 'ejs');
app.set('views', '.');

// Serv√≠rovat statick√© soubory z pages slo≈æky (CSS, obr√°zky)
app.use('/pages', express.static('pages'));

// Serv√≠rovat statick√© soubory z Gallery slo≈æky (CSS, JS)
app.use('/Gallery', express.static('Gallery'));

// Inicializace Supabase
const supabaseUrl = process.env.SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
const supabaseAnonKey = process.env.SUPABASE_ANON_KEY;

console.log('üîß Supabase config check:');
console.log('  - URL:', supabaseUrl ? '‚úÖ Set' : '‚ùå Missing');
console.log('  - Service Key:', supabaseServiceKey ? '‚úÖ Set' : '‚ùå Missing');
console.log('  - Anon Key:', supabaseAnonKey ? '‚úÖ Set' : '‚ùå Missing');

const supabase = createClient(supabaseUrl, supabaseAnonKey);
const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey);

// Inicializace Stripe
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);
const STRIPE_WEBHOOK_SECRET = process.env.STRIPE_WEBHOOK_SECRET;

// Pricing konfigurace
const PRICING = {
  free: {
    name: 'Free',
    price: 0,
    icon_limit: 100,
    features: ['100 SVG ikon', 'Z√°kladn√≠ podpora', 'Komprese ikon']
  },
  pro: {
    name: 'Pro',
    price: 9.99,
    price_id: process.env.STRIPE_PRO_PRICE_ID,
    icon_limit: 1000,
    features: ['1000 SVG ikon', 'Prioritn√≠ podpora', 'API p≈ô√≠stup', 'Komprese ikon']
  }
};

// ===== HELPER FUNKCE =====

// Komprese SVG pomoc√≠ gzip
function compressSvg(svgContent) {
  const compressed = pako.gzip(svgContent);
  return Buffer.from(compressed).toString('base64');
}

// Dekomprese SVG
function decompressSvg(compressedBase64) {
  const buffer = Buffer.from(compressedBase64, 'base64');
  const decompressed = pako.ungzip(buffer, { to: 'string' });
  return decompressed;
}

// V√Ωpoƒçet velikost√≠
function calculateSizes(svgContent) {
  const originalSize = (new Blob([svgContent]).size / 1024).toFixed(2);
  const compressedContent = compressSvg(svgContent);
  const compressedSize = (compressedContent.length * 0.75 / 1024).toFixed(2);
  return { originalSize, compressedSize, compressedContent };
}

// Middleware pro autentizaci
async function authenticate(req, res, next) {
  const token = req.headers.authorization?.split(' ')[1];
  
  if (!token) {
    console.log('‚ö†Ô∏è Authentication failed: No token provided');
    return res.status(401).json({ error: 'No token provided' });
  }
  
  const { data: { user }, error } = await supabase.auth.getUser(token);
  
  if (error || !user) {
    console.log('‚ö†Ô∏è Authentication failed: Invalid token', error?.message);
    return res.status(401).json({ error: 'Invalid token' });
  }
  
  console.log('‚úÖ Authentication successful:', user.email);
  req.user = user;
  next();
}

// Middleware pro admin autentizaci
async function authenticateAdmin(req, res, next) {
  await authenticate(req, res, async () => {
    const { data: profile } = await supabase
      .from('user_profiles')
      .select('is_admin')
      .eq('id', req.user.id)
      .single();
    
    if (!profile || !profile.is_admin) {
      return res.status(403).json({ error: 'Admin access required' });
    }
    
    next();
  });
}

// ===== AUTHENTIZAƒåN√ç ENDPOINTY =====

// Jednotn√Ω OTP-only endpoint - bez aktivace, jen OTP k√≥d pro v≈°echny
app.post('/api/auth/initiate', async (req, res) => {
  try {
    console.log('üì• Auth initiate request');
    
    const { email } = req.body;
    
    // Validace emailu
    if (!email) {
      return res.status(400).json({ error: 'Email is required' });
    }
    
    const trimmedEmail = email.trim();
    if (!trimmedEmail) {
      return res.status(400).json({ error: 'Email cannot be empty' });
    }
    
    // Z√°kladn√≠ validace email form√°tu
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(trimmedEmail)) {
      return res.status(400).json({ error: 'Invalid email format' });
    }
    
    console.log('‚úÖ Sending OTP to:', trimmedEmail);
    
    // Zkontrolovat limit u≈æivatel≈Ø (pouze pro nov√© u≈æivatele)
    try {
      const { data: usersData } = await supabaseAdmin.auth.admin.listUsers();
      const user = usersData?.users?.find(u => u.email?.toLowerCase() === trimmedEmail.toLowerCase());
      
      if (!user) {
        // Nov√Ω u≈æivatel - zkontrolovat limit
        const activeUsers = usersData.users.filter(u => u.email_confirmed_at !== null);
        const MAX_USERS = 100;
        
        if (activeUsers.length >= MAX_USERS) {
          return res.status(403).json({ 
            error: 'User registration limit reached',
            code: 'USER_LIMIT_REACHED'
          });
        }
      }
    } catch (err) {
      console.error('Error checking user limit:', err);
    }
    
    // Poslat OTP k√≥d - Supabase automaticky vytvo≈ô√≠ u≈æivatele, pokud neexistuje
    const { error } = await supabase.auth.signInWithOtp({
      email: trimmedEmail,
      options: {
        shouldCreateUser: true,  // Vytvo≈ô√≠ √∫ƒçet, pokud neexistuje
      }
    });
    
    if (error) {
      console.error('‚ùå OTP error:', error.message);
      return res.status(400).json({ error: error.message });
    }
    
    console.log('‚úÖ OTP sent to:', trimmedEmail);
    res.json({ 
      type: 'login',
      message: 'Verification code sent to your email',
      email: trimmedEmail 
    });
  } catch (error) {
    console.error('‚ùå Error in initiate:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// Resend OTP - poslat nov√Ω k√≥d (zjednodu≈°en√° verze)
app.post('/api/auth/resend', async (req, res) => {
  try {
    const { email } = req.body;
    
    if (!email) {
      return res.status(400).json({ error: 'Email is required' });
    }
    
    // Jednodu≈°e poslat nov√Ω OTP k√≥d
    const { error } = await supabase.auth.signInWithOtp({
      email: email.trim(),
      options: {
        shouldCreateUser: true,
      }
    });
    
    if (error) {
      return res.status(400).json({ error: error.message });
    }
    
    res.json({ 
      type: 'login',
      message: 'Verification code sent to your email',
      email: email.trim()
    });
  } catch (error) {
    console.error('‚ùå Error in resend:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// Registrace - DEPRECATED, pou≈æijte /api/auth/initiate
app.post('/api/auth/register', async (req, res) => {
  // Redirect na initiate endpoint
  req.url = '/api/auth/initiate';
  return app._router.handle(req, res, () => {});
});

// P≈ôihl√°≈°en√≠ - DEPRECATED, pou≈æijte /api/auth/initiate
app.post('/api/auth/login', async (req, res) => {
  // Redirect na initiate endpoint
  req.url = '/api/auth/initiate';
  return app._router.handle(req, res, () => {});
});

// Ovƒõ≈ôen√≠ OTP k√≥du
app.post('/api/auth/verify', async (req, res) => {
  try {
    const { email, token } = req.body;
    
    if (!email || !token) {
      return res.status(400).json({ error: 'Email and verification code are required' });
    }
    
    // Odebrat pomlƒçky z tokenu (XXX-XXX -> XXXXXX)
    const cleanToken = token.replace(/-/g, '').toUpperCase();
    
    // Ovƒõ≈ôit OTP k√≥d
    const { data, error } = await supabase.auth.verifyOtp({
      email,
      token: cleanToken,
      type: 'email'
    });
    
    if (error) {
      return res.status(401).json({ error: 'Invalid verification code' });
    }
    
    // Zkontrolovat, zda existuje user profile, pokud ne, vytvo≈ôit ho
    const { data: profile } = await supabase
      .from('user_profiles')
      .select('*')
      .eq('id', data.user.id)
      .single();
    
    if (!profile) {
      await supabase.from('user_profiles').insert({
        id: data.user.id,
        email: data.user.email,
        tier: 'free',
        icon_limit: 100,
        subscription_status: 'active'
      });
    }
    
    console.log(`‚úÖ U≈æivatel p≈ôihl√°≈°en: ${email}`);
    res.json({ 
      token: data.session.access_token,
      email: data.user.email 
    });
  } catch (error) {
    console.error('Chyba p≈ôi ovƒõ≈ôen√≠:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// Resend aktivaƒçn√≠ho linku pro neaktivovan√© √∫ƒçty - DEPRECATED
// Pou≈æijte /api/auth/resend m√≠sto tohoto
app.post('/api/auth/resend-activation', async (req, res) => {
  // Redirect na nov√Ω resend endpoint
  req.url = '/api/auth/resend';
  return app._router.handle(req, res, () => {});
});

// HTML str√°nka pro aktivaci √∫ƒçtu - DEPRECATED (u≈æ nepou≈æ√≠v√°me aktivaci)
app.get('/activate', (req, res) => {
  res.send('<h1>Activation no longer required</h1><p>Please use the OTP code from your email to log in.</p>');
});

// Aktivace √∫ƒçtu p≈ôes magic link - DEPRECATED (u≈æ nepou≈æ√≠v√°me aktivaci)
app.get('/api/auth/activate', (req, res) => {
  res.redirect('/activate');
});

// ===== GALERIE ENDPOINTY =====

app.post('/api/gallery', authenticate, async (req, res) => {
  try {
    console.log('üîµ POST /api/gallery - Request received');
    console.log('üìß User:', req.user?.email, 'ID:', req.user?.id);
    
    const { svg, source, name, size } = req.body;
    console.log('üì¶ Request data:', { 
      svgLength: svg?.length, 
      source, 
      name,
      size
    });
          checkMethod = 'auth-success';
          console.log('‚úÖ Auth check result:', {
            exists: userExists,
            userId: authUser.user.id,
            email: authUser.user.email,
            confirmed: emailConfirmed ? 'yes' : 'no',
            email_confirmed_at: authUser.user.email_confirmed_at
          });
        }
      } else {
        userExists = false;
        checkMethod = 'auth-not-found';
        console.log('‚ÑπÔ∏è User not found in Auth');
      }
    } catch (err) {
      console.error('‚ùå Auth check exception:', {
        message: err.message,
        stack: err.stack,
        name: err.name
      });
      // Pokraƒçujeme s datab√°zovou kontrolou
    }
    
    // 2. Kontrola v datab√°zi user_profiles (backup kontrola)
    // Toto zachyt√≠ p≈ô√≠pady, kdy u≈æivatel existuje v DB, ale Auth kontrola selhala
    if (!userExists || checkMethod === '') {
      try {
        console.log('üîç Checking user in database (user_profiles)...');
        const { data: profileData, error: profileError } = await supabaseAdmin
          .from('user_profiles')
          .select('id, email, created_at')
          .eq('email', trimmedEmail)
          .maybeSingle();
        
        if (profileError) {
          console.log('‚ÑπÔ∏è Database check error:', {
            message: profileError.message,
            code: profileError.code,
            details: profileError.details
          });
        } else if (profileData) {
          // U≈æivatel existuje v datab√°zi - zkusit naj√≠t v Auth
          userExists = true;
          checkMethod = checkMethod ? `${checkMethod}+db` : 'db-only';
          console.log('‚úÖ Database check found user:', {
            userId: profileData.id,
            email: profileData.email,
            created_at: profileData.created_at
          });
          
          // Pokud u≈æivatel existuje v DB, ale ne v Auth, zkusit ho naj√≠t v Auth podle ID
          if (checkMethod === 'db-only') {
            try {
              const { data: authUserById, error: authByIdError } = await supabaseAdmin.auth.admin.getUserById(profileData.id);
              if (!authByIdError && authUserById && authUserById.user) {
                const emailConfirmed = authUserById.user.email_confirmed_at !== null;
                
                console.log('‚úÖ Found user in Auth by ID:', {
                  userId: authUserById.user.id,
                  email: authUserById.user.email,
                  confirmed: emailConfirmed ? 'yes' : 'no',
                  email_confirmed_at: authUserById.user.email_confirmed_at
                });
                
                checkMethod = 'db+auth-by-id';
                
                // ‚≠ê NOV√Å KONTROLA: Pokud email nen√≠ potvrzen√Ω, pova≈æovat za nov√©ho
                if (!emailConfirmed) {
                  console.warn('‚ö†Ô∏è User found by ID but email NOT confirmed - treating as NEW USER');
                  userExists = false;
                  checkMethod = 'db+auth-unconfirmed';
                }
              } else {
                console.warn('‚ö†Ô∏è User exists in DB but not in Auth - will use OTP anyway');
              }
            } catch (err) {
              console.log('‚ÑπÔ∏è Could not check Auth by ID:', err.message);
            }
          }
        } else {
          console.log('‚ÑπÔ∏è Database check: user not found');
          if (!checkMethod) {
            checkMethod = 'db-not-found';
          }
        }
      } catch (dbErr) {
        console.error('‚ùå Database check exception:', {
          message: dbErr.message,
          stack: dbErr.stack,
          name: dbErr.name
        });
      }
    }
    
    // Fin√°ln√≠ logov√°n√≠ v√Ωsledku kontroly
    console.log('üìä Final user existence check:', {
      email: trimmedEmail,
      exists: userExists,
      checkMethod: checkMethod,
      timestamp: new Date().toISOString()
    });
    
    // ‚≠ê NOV√Å KONTROLA: Zkontrolovat limit u≈æivatel≈Ø P≈òED vytvo≈ôen√≠m nov√©ho √∫ƒçtu
    if (!userExists) {
      console.log('üîç Checking user limit before registration...');
      
      try {
        // Poƒç√≠tat pouze aktivn√≠ u≈æivatele (s potvrzen√Ωm emailem)
        const { data: { users }, error: usersError } = await supabaseAdmin.auth.admin.listUsers();
        
        if (usersError) {
          console.error('‚ùå Error checking user count:', usersError);
          return res.status(500).json({ 
            error: 'Failed to check user limit',
            code: 'USER_LIMIT_CHECK_FAILED'
          });
        }
        
        // Filtrovat pouze aktivn√≠ u≈æivatele (s potvrzen√Ωm emailem)
        const activeUsers = users.filter(u => u.email_confirmed_at !== null);
        const userCount = activeUsers.length;
        
        console.log(`üìä Current active users: ${userCount}/100`);
        
        const MAX_USERS = 100;
        if (userCount >= MAX_USERS) {
          console.warn(`‚ö†Ô∏è User limit reached: ${userCount}/${MAX_USERS}`);
          return res.status(403).json({ 
            error: 'User registration limit reached. Maximum 100 users allowed.',
            code: 'USER_LIMIT_REACHED',
            current: userCount,
            limit: MAX_USERS
          });
        }
        
        console.log(`‚úÖ User limit OK: ${userCount}/${MAX_USERS}`);
      } catch (limitCheckError) {
        console.error('‚ùå Exception checking user limit:', {
          message: limitCheckError.message,
          stack: limitCheckError.stack,
          name: limitCheckError.name
        });
        return res.status(500).json({ 
          error: 'Failed to check user limit',
          code: 'USER_LIMIT_CHECK_EXCEPTION'
        });
      }
    }
    
    const frontendUrl = process.env.FRONTEND_URL || 'https://svag.vercel.app';
    
    if (userExists) {
      // U≈æivatel existuje - poslat OTP k√≥d pro p≈ôihl√°≈°en√≠
      console.log('üîê User exists, sending OTP for login');
      console.log('üìß Sending OTP to:', trimmedEmail);
      console.log('‚öôÔ∏è OTP options:', { shouldCreateUser: false });
      
      try {
        // ‚≠ê KL√çƒåOV√â: BEZ emailRedirectTo = po≈°le se OTP k√≥d (6 ƒç√≠slic)
        // S emailRedirectTo = po≈°le se Magic Link (dlouh√Ω token)
        const { data, error } = await supabase.auth.signInWithOtp({
          email: trimmedEmail,
          options: {
            shouldCreateUser: false,
            // D≈ÆLE≈ΩIT√â: NENASTAVOVAT emailRedirectTo!
            // Pokud je emailRedirectTo nastaven, po≈°le se Magic Link m√≠sto OTP k√≥du
          }
        });
        
        if (error) {
          console.error('‚ùå Supabase OTP error:', {
            message: error.message,
            status: error.status,
            name: error.name,
            email: trimmedEmail
          });
          
          // Pokud OTP sel≈æe, ale u≈æivatel existuje v DB, zkusit pou≈æ√≠t admin API
          if (checkMethod.includes('db') && !checkMethod.includes('auth')) {
            console.warn('‚ö†Ô∏è OTP failed but user exists in DB - trying admin resend');
            // Zkusit pou≈æ√≠t admin API pro posl√°n√≠ OTP
            try {
              const { data: adminResend, error: adminError } = await supabaseAdmin.auth.admin.generateLink({
                type: 'magiclink',
                email: trimmedEmail,
                options: {
                  redirectTo: `${frontendUrl}/api/auth/activate`
                }
              });
              
              if (!adminError && adminResend) {
                console.log('‚úÖ Admin magic link generated');
                // Admin API generuje link, ale nepos√≠l√° email - mus√≠me pou≈æ√≠t jin√Ω p≈ô√≠stup
                // Vr√°tit chybu s informac√≠, ≈æe u≈æivatel existuje
                return res.status(400).json({ 
                  error: 'User exists but OTP cannot be sent. Please use password reset or contact support.',
                  code: 'OTP_SEND_FAILED_USER_EXISTS'
                });
              }
            } catch (adminErr) {
              console.error('‚ùå Admin resend error:', adminErr);
            }
          }
          
          // Speci√°ln√≠ handling pro r≈Øzn√© typy chyb
          if (error.message && error.message.includes('already registered')) {
            console.warn('‚ö†Ô∏è User already registered but check failed - possible race condition');
            return res.status(400).json({ 
              error: 'User already exists. Please try logging in.',
              code: 'USER_EXISTS'
            });
          }
          
          return res.status(400).json({ 
            error: error.message || 'Failed to send OTP code',
            code: 'OTP_SEND_FAILED'
          });
        }
        
        console.log('‚úÖ OTP k√≥d odesl√°n na:', trimmedEmail, {
          timestamp: new Date().toISOString(),
          checkMethod: checkMethod
        });
        
        res.json({ 
          type: 'login',
          message: 'Verification code sent to your email',
          email: trimmedEmail 
        });
      } catch (otpErr) {
        console.error('‚ùå OTP send exception:', {
          message: otpErr.message,
          stack: otpErr.stack,
          name: otpErr.name,
          email: trimmedEmail
        });
        return res.status(500).json({ 
          error: 'Failed to send verification code',
          code: 'OTP_EXCEPTION'
        });
      }
    } else {
      // U≈æivatel neexistuje - vytvo≈ôit √∫ƒçet a poslat confirmation email
      console.log('üìù New user, creating account and sending confirmation email');
      console.log('üìß Sending confirmation email to:', trimmedEmail);
      console.log('‚öôÔ∏è SignUp options:', { 
        emailRedirectTo: `${frontendUrl}/api/auth/activate`,
      });
      
      try {
        // P≈òED vytvo≈ôen√≠m je≈°tƒõ jednou zkontrolujeme (ochrana proti race condition)
        const { data: finalCheck } = await supabaseAdmin
          .from('user_profiles')
          .select('id, email')
          .eq('email', trimmedEmail)
          .maybeSingle();
        
        if (finalCheck) {
          console.warn('‚ö†Ô∏è User found in database during final check - switching to login flow');
          // P≈ôepnout na login flow - poslat OTP K√ìD (ne Magic Link!)
          const { data, error } = await supabase.auth.signInWithOtp({
            email: trimmedEmail,
            options: {
              shouldCreateUser: false,
              // NENASTAVOVAT emailRedirectTo = po≈°le se OTP k√≥d m√≠sto Magic Link
            }
          });
          
          if (error) {
            console.error('‚ùå Failed to send OTP after final check:', error);
            return res.status(400).json({ 
              error: error.message || 'Failed to send verification code',
              code: 'OTP_SEND_FAILED'
            });
          }
          
          console.log('‚úÖ OTP k√≥d sent after final check');
          return res.json({ 
            type: 'login',
            message: 'Verification code sent to your email',
            email: trimmedEmail 
          });
        }
        
        // ‚≠ê ZMƒöNA: Pou≈æ√≠t signUp m√≠sto signInWithOtp pro nov√© u≈æivatele
        const { data, error } = await supabase.auth.signUp({
          email: trimmedEmail,
          password: Math.random().toString(36).slice(-16) + Math.random().toString(36).slice(-16), // N√°hodn√© heslo
          options: {
            emailRedirectTo: `${frontendUrl}/api/auth/activate`,
            data: {
              email: trimmedEmail,
            }
          }
        });
        
        if (error) {
          console.error('‚ùå Supabase signUp error:', {
            message: error.message,
            status: error.status,
            name: error.name,
            email: trimmedEmail,
            details: error
          });
          
          // Speci√°ln√≠ handling pro duplicitn√≠ u≈æivatele
          if (error.message && (
            error.message.includes('already registered') ||
            error.message.includes('User already registered')
          )) {
            console.warn('‚ö†Ô∏è User already registered - possible race condition, switching to OTP');
            // Zkusit poslat OTP k√≥d (BEZ emailRedirectTo!) m√≠sto magic linku
            const { data: otpData, error: otpError } = await supabase.auth.signInWithOtp({
              email: trimmedEmail,
              options: {
                shouldCreateUser: false,
                // NENASTAVOVAT emailRedirectTo = po≈°le se OTP k√≥d m√≠sto Magic Link
              }
            });
            
            if (!otpError) {
              console.log('‚úÖ Switched to OTP after duplicate detection');
              return res.json({ 
                type: 'login',
                message: 'Verification code sent to your email',
                email: trimmedEmail 
              });
            }
          }
          
          return res.status(400).json({ 
            error: error.message || 'Failed to send activation link',
            code: 'SIGNUP_FAILED'
          });
        }
        
        console.log('‚úÖ Confirmation email sent (signUp) to:', trimmedEmail, {
          timestamp: new Date().toISOString(),
          checkMethod: checkMethod,
          userId: data?.user?.id,
          userEmail: data?.user?.email
        });
        
        res.json({ 
          type: 'register',
          message: 'Activation link sent to your email',
          email: trimmedEmail 
        });
      } catch (signUpErr) {
        console.error('‚ùå SignUp exception:', {
          message: signUpErr.message,
          stack: signUpErr.stack,
          name: signUpErr.name,
          email: trimmedEmail
        });
        return res.status(500).json({ 
          error: 'Failed to send activation link',
          code: 'SIGNUP_EXCEPTION'
        });
      }
    }
  } catch (error) {
    console.error('‚ùå Chyba p≈ôi iniciaci:', error);
    console.error('‚ùå Error stack:', error.stack);
    res.status(500).json({ 
      error: 'Internal server error',
      message: error.message 
    });
  }
});

// Registrace - pos√≠l√° aktivn√≠ link (deprecated, pou≈æijte /api/auth/initiate)
app.post('/api/auth/register', async (req, res) => {
  try {
    const { email } = req.body;
    
    if (!email) {
      return res.status(400).json({ error: 'Email is required' });
    }
    
    // Ovƒõ≈ôit, zda u≈æivatel u≈æ existuje
    try {
      const { data: existingUser } = await supabaseAdmin.auth.admin.getUserByEmail(email);
      
      if (existingUser && existingUser.user) {
        return res.status(400).json({ error: 'User already exists' });
      }
    } catch (err) {
      // Pokud u≈æivatel neexistuje, pokraƒçujeme
    }
    
    // ‚≠ê KONTROLA LIMITU U≈ΩIVATEL≈Æ (stejn√° jako v /api/auth/initiate)
    try {
      const { data: { users }, error: usersError } = await supabaseAdmin.auth.admin.listUsers();
      
      if (!usersError && users) {
        const activeUsers = users.filter(u => u.email_confirmed_at !== null);
        const userCount = activeUsers.length;
        const MAX_USERS = 100;
        
        if (userCount >= MAX_USERS) {
          return res.status(403).json({ 
            error: 'User registration limit reached. Maximum 100 users allowed.',
            code: 'USER_LIMIT_REACHED',
            current: userCount,
            limit: MAX_USERS
          });
        }
      }
    } catch (limitErr) {
      console.error('Error checking user limit:', limitErr);
      // Pokraƒçujeme i p≈ôi chybƒõ kontroly limitu (nechceme blokovat registraci kv≈Øli technick√© chybƒõ)
    }
    
    // Poslat magic link pro aktivaci √∫ƒçtu
    const frontendUrl = process.env.FRONTEND_URL || 'https://svag.vercel.app';
    const { data, error } = await supabase.auth.signInWithOtp({
      email,
      options: {
        emailRedirectTo: `${frontendUrl}/api/auth/activate`,
        shouldCreateUser: true,
      }
    });
    
    if (error) {
      return res.status(400).json({ error: error.message });
    }
    
    console.log(`‚úÖ Aktivn√≠ link odesl√°n na: ${email}`);
    res.json({ 
      message: 'Activation link sent to your email',
      email: email 
    });
  } catch (error) {
    console.error('Chyba p≈ôi registraci:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// P≈ôihl√°≈°en√≠ - pos√≠l√° 6m√≠stn√Ω k√≥d
app.post('/api/auth/login', async (req, res) => {
  try {
    const { email } = req.body;
    
    if (!email) {
      return res.status(400).json({ error: 'Email is required' });
    }
    
    // Ovƒõ≈ôit, zda u≈æivatel existuje
    try {
      const { data: user } = await supabaseAdmin.auth.admin.getUserByEmail(email);
      
      if (!user || !user.user) {
        return res.status(404).json({ error: 'User not found. Please register first.' });
      }
    } catch (err) {
      return res.status(404).json({ error: 'User not found. Please register first.' });
    }
    
    // Poslat OTP k√≥d ve form√°tu XXX-XXX
    const { data, error } = await supabase.auth.signInWithOtp({
      email,
      options: {
        shouldCreateUser: false,
      }
    });
    
    if (error) {
      return res.status(400).json({ error: error.message });
    }
    
    console.log(`‚úÖ OTP k√≥d odesl√°n na: ${email}`);
    res.json({ 
      message: 'Verification code sent to your email',
      email: email 
    });
  } catch (error) {
    console.error('Chyba p≈ôi p≈ôihl√°≈°en√≠:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// Ovƒõ≈ôen√≠ OTP k√≥du
app.post('/api/auth/verify', async (req, res) => {
  try {
    const { email, token } = req.body;
    
    if (!email || !token) {
      return res.status(400).json({ error: 'Email and verification code are required' });
    }
    
    // Odebrat pomlƒçky z tokenu (XXX-XXX -> XXXXXX)
    const cleanToken = token.replace(/-/g, '').toUpperCase();
    
    // Ovƒõ≈ôit OTP k√≥d
    const { data, error } = await supabase.auth.verifyOtp({
      email,
      token: cleanToken,
      type: 'email'
    });
    
    if (error) {
      return res.status(401).json({ error: 'Invalid verification code' });
    }
    
    // Zkontrolovat, zda existuje user profile, pokud ne, vytvo≈ôit ho
    const { data: profile } = await supabase
      .from('user_profiles')
      .select('*')
      .eq('id', data.user.id)
      .single();
    
    if (!profile) {
      await supabase.from('user_profiles').insert({
        id: data.user.id,
        email: data.user.email,
        tier: 'free',
        icon_limit: 100,
        subscription_status: 'active'
      });
    }
    
    console.log(`‚úÖ U≈æivatel p≈ôihl√°≈°en: ${email}`);
    res.json({ 
      token: data.session.access_token,
      email: data.user.email 
    });
  } catch (error) {
    console.error('Chyba p≈ôi ovƒõ≈ôen√≠:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// Resend aktivaƒçn√≠ho linku pro neaktivovan√© √∫ƒçty
app.post('/api/auth/resend-activation', async (req, res) => {
  try {
    const { email } = req.body;
    
    if (!email) {
      return res.status(400).json({ error: 'Email is required' });
    }
    
    console.log('üìß Resending activation link to:', email);
    
    const frontendUrl = process.env.FRONTEND_URL || 'https://svag.vercel.app';
    
    // Nejd≈ô√≠v zkontrolovat, jestli u≈æivatel existuje a jestli je potvrzen√Ω
    try {
      const { data: usersData } = await supabaseAdmin.auth.admin.listUsers();
      const user = usersData?.users?.find(u => u.email?.toLowerCase() === email.toLowerCase());
      
      if (!user) {
        console.log('‚ùå User not found, cannot resend');
        return res.status(404).json({ error: 'User not found' });
      }
      
      console.log('‚úÖ User found:', {
        id: user.id,
        email: user.email,
        confirmed: !!user.email_confirmed_at,
        email_confirmed_at: user.email_confirmed_at
      });
      
      // Pokud u≈æ je potvrzen√Ω, poslat OTP pro login (ne aktivaƒçn√≠ link)
      if (user.email_confirmed_at) {
        console.log('‚úÖ User already confirmed, sending OTP for login');
        const { error } = await supabase.auth.signInWithOtp({
          email: email,
          options: {
            shouldCreateUser: false,
          }
        });
        
        if (error) {
          console.error('‚ùå Error sending OTP:', error);
          return res.status(400).json({ error: error.message });
        }
        
        console.log('‚úÖ OTP sent for login');
        return res.json({ 
          message: 'Login code sent to your email',
          type: 'login',
          email: email 
        });
      }
      
      // Pokud nen√≠ potvrzen√Ω, znovu poslat signup email s aktivaƒçn√≠m linkem
      console.log('üìß User not confirmed yet, resending signup confirmation');
      
      // Pou≈æ√≠t resend z Supabase (po≈°le nov√Ω confirmation email)
      const { error: resendError } = await supabaseAdmin.auth.resend({
        type: 'signup',
        email: email,
        options: {
          emailRedirectTo: `${frontendUrl}/api/auth/activate`
        }
      });
      
      if (resendError) {
        console.error('‚ùå Error with resend:', resendError);
        // Pokud resend nen√≠ dostupn√Ω, pou≈æ√≠t workaround
        console.log('‚ö†Ô∏è Trying alternative method...');
        
        // Odstranit nepotvrzen√©ho u≈æivatele a vytvo≈ôit znovu
        await supabaseAdmin.auth.admin.deleteUser(user.id);
        console.log('üóëÔ∏è Deleted unconfirmed user');
        
        // Vytvo≈ôit znovu s nov√Ωm confirmation emailem
        const { error: signUpError } = await supabase.auth.signUp({
          email: email,
          password: Math.random().toString(36).slice(-16) + Math.random().toString(36).slice(-16),
          options: {
            emailRedirectTo: `${frontendUrl}/api/auth/activate`,
          }
        });
        
        if (signUpError) {
          console.error('‚ùå Error with signUp:', signUpError);
          return res.status(400).json({ error: signUpError.message });
        }
        
        console.log('‚úÖ New activation email sent (via re-signup)');
        return res.json({ 
          message: 'Activation link sent to your email',
          type: 'register',
          email: email 
        });
      }
      
      console.log('‚úÖ Confirmation email resent');
      return res.json({ 
        message: 'Activation link sent to your email',
        type: 'register',
        email: email 
      });
      
    } catch (listError) {
      console.error('‚ùå Error checking user:', listError);
      return res.status(500).json({ error: 'Failed to check user status' });
    }
    
  } catch (error) {
    console.error('‚ùå Error in resend-activation:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// HTML str√°nka pro aktivaci √∫ƒçtu (inline HTML - bez EJS z√°vislost√≠)
app.get('/activate', (req, res) => {
  const { success, error, token, message } = req.query;
  const apiUrl = process.env.FRONTEND_URL || 'https://svag.vercel.app';
  
  // √öspƒõ≈°n√° aktivace s tokenem - auto-redirect na galerii
  if (success === 'true' && token) {
    const html = generateActivateSuccessHTML(token, apiUrl);
    return res.send(html);
  }
  
  // √öspƒõ≈°n√° aktivace bez tokenu (ji≈æ aktivovan√Ω √∫ƒçet)
  if (success === 'true' && message === 'activated') {
    const html = generateActivateAlreadyHTML();
    return res.send(html);
  }
  
  // Chyba p≈ôi aktivaci
  if (error) {
    let errorMessage = 'Nezn√°m√° chyba';
    if (error === 'invalid') {
      errorMessage = 'Neplatn√Ω nebo expirovan√Ω aktivaƒçn√≠ link.';
    } else if (error === 'server') {
      errorMessage = 'Chyba serveru. Zkuste to pros√≠m znovu.';
    }
    const html = generateActivateErrorHTML(errorMessage);
    return res.send(html);
  }
  
  // ≈Ω√°dn√© parametry - zobrazit error
  const html = generateActivateErrorHTML('Pros√≠m pou≈æijte aktivaƒçn√≠ link z emailu.');
  res.send(html);
});

// Helper funkce pro generov√°n√≠ HTML
function generateActivateSuccessHTML(token, apiUrl) {
  return '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>You finally have svag</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;background:#fff;min-height:100vh}.success-container{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;width:100%;height:100vh;background:#fff}.success-content{display:flex;flex-direction:column;gap:48px;align-items:center;justify-content:center;padding:48px;width:100%;text-align:center}.success-title{font-family:Inter,sans-serif;font-weight:700;font-size:48px;line-height:normal;letter-spacing:.48px;color:#070707;margin:0}.success-text{font-family:Inter,sans-serif;font-weight:400;font-size:14px;line-height:24px;letter-spacing:.14px;color:rgba(0,0,0,.5);max-width:318px;margin:0}.success-btn{background:#22f43e;color:#000;border:none;padding:12px 48px;border-radius:12px;font-family:Inter,sans-serif;font-weight:500;font-size:16px;line-height:18px;letter-spacing:.16px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;height:54px;max-width:420px;transition:all .2s ease;white-space:nowrap}.success-btn:hover{background:#1de635;transform:translateY(-1px)}.success-hint{font-size:14px;color:rgba(0,0,0,.5);margin-top:20px}@media (max-width:480px){.success-title{font-size:32px}.success-content{padding:24px;gap:32px}}</style></head><body class="success-page"><div class="success-container"><div class="success-content"><h1 class="success-title">You finally have svag</h1><p class="success-text">Your account has been activated successfully.<br>Redirecting to gallery...</p><p class="success-hint" id="manualLink" style="display:none"><a href="#" onclick="openGallery();return false" class="success-btn">Open Gallery</a></p></div></div><script>const token="' + token + '";const apiUrl="' + apiUrl + '";let userEmail="";try{const payload=JSON.parse(atob(token.split(".")[1]));userEmail=payload.email||""}catch(e){console.error("Failed to decode token:",e)}function syncToExtension(){if(token&&userEmail){console.log("üì§ Sending login to extension via postMessage");window.postMessage({source:"svag-gallery",action:"galleryLogin",token:token,email:userEmail,apiUrl:apiUrl},"*");return true}return false}function openGallery(){if(token&&userEmail){console.log("üíæ Saving to localStorage");localStorage.setItem("token",token);localStorage.setItem("userEmail",userEmail)}const synced=syncToExtension();console.log("Extension sync initiated:",synced);setTimeout(()=>{console.log("üîÑ Redirecting to gallery...");if(token&&userEmail){window.location.href=apiUrl+"/gallery?token="+encodeURIComponent(token)+"&email="+encodeURIComponent(userEmail)}else{window.location.href=apiUrl+"/gallery"}},500)}setTimeout(()=>{openGallery()},2e3);setTimeout(()=>{document.getElementById("manualLink").style.display="block"},5e3)</script></body></html>';
}

function generateActivateAlreadyHTML() {
  return '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>You finally have svag</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;background:#fff;min-height:100vh}.success-container{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;width:100%;height:100vh;background:#fff}.success-content{display:flex;flex-direction:column;gap:48px;align-items:center;justify-content:center;padding:48px;width:100%;text-align:center}.success-title{font-family:Inter,sans-serif;font-weight:700;font-size:48px;line-height:normal;letter-spacing:.48px;color:#070707;margin:0}.success-text{font-family:Inter,sans-serif;font-weight:400;font-size:14px;line-height:24px;letter-spacing:.14px;color:rgba(0,0,0,.5);max-width:318px;margin:0}.success-btn{background:#22f43e;color:#000;border:none;padding:12px 48px;border-radius:12px;font-family:Inter,sans-serif;font-weight:500;font-size:16px;line-height:18px;letter-spacing:.16px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;height:54px;max-width:420px;transition:all .2s ease;white-space:nowrap}.success-btn:hover{background:#1de635;transform:translateY(-1px)}@media (max-width:480px){.success-title{font-size:32px}.success-content{padding:24px;gap:32px}}</style></head><body class="success-page"><div class="success-container"><div class="success-content"><h1 class="success-title">You finally have svag</h1><p class="success-text">Your account has been activated successfully.<br>You can now login to the Chrome extension<br>and start using svag.</p><a href="javascript:window.close()" class="success-btn">Close window</a></div></div></body></html>';
}

function generateActivateErrorHTML(errorMessage) {
  return '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Activation error</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;background:#fff;min-height:100vh}.error-container{display:flex;flex-direction:column;gap:48px;align-items:center;justify-content:center;padding:48px;max-width:100%;width:100%;min-height:100vh}.error-content{display:flex;flex-direction:column;gap:24px;align-items:center;text-align:center;width:100%;max-width:420px}.error-title{font-family:Inter,sans-serif;font-size:48px;font-weight:700;line-height:normal;letter-spacing:.48px;color:#070707;margin:0}.error-message{font-family:Inter,sans-serif;font-size:14px;font-weight:700;line-height:24px;letter-spacing:.14px;color:#070707;margin:0;max-width:420px}.error-description{font-family:Inter,sans-serif;font-size:14px;font-weight:400;line-height:24px;letter-spacing:.14px;color:rgba(0,0,0,.5);margin:0;max-width:420px}.error-btn{background:#e50000;color:#fff;border:none;padding:12px 48px;border-radius:12px;font-family:Inter,sans-serif;font-size:16px;font-weight:500;line-height:18px;letter-spacing:.16px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;height:54px;max-width:420px;transition:all .3s ease;white-space:nowrap}.error-btn:hover{background:#c00;transform:translateY(-2px);box-shadow:0 4px 12px rgba(229,0,0,.3)}@media (max-width:480px){.error-container{padding:24px}.error-title{font-size:32px}.error-btn{padding:12px 32px;width:100%}}</style></head><body class="error-page"><div class="error-container"><div class="error-content"><h1 class="error-title">Activation error</h1><p class="error-message">' + errorMessage + '</p><p class="error-description">Request a new activation link in the Chrome extension or try the registration process again.</p></div><a href="javascript:window.close()" class="error-btn">Close window</a></div></body></html>';
}

// Pomocn√° funkce pro vytvo≈ôen√≠ user profile
async function createUserProfileIfNeeded(userId, userEmail) {
  try {
    const { data: profile } = await supabase
      .from('user_profiles')
      .select('*')
      .eq('id', userId)
      .single();
    
    if (!profile) {
      console.log('üìù Creating user profile...');
      const { error: insertError } = await supabase.from('user_profiles').insert({
        id: userId,
        email: userEmail,
        tier: 'free',
        icon_limit: 100,
        subscription_status: 'active'
      });
      
      if (insertError) {
        console.error('‚ùå Error creating profile:', insertError);
        return false;
      } else {
        console.log('‚úÖ User profile created');
        return true;
      }
    } else {
      console.log('‚úÖ User profile already exists');
      return true;
    }
  } catch (err) {
    console.error('‚ùå Exception creating profile:', err);
    return false;
  }
}

// Aktivace √∫ƒçtu p≈ôes magic link (vol√°no z redirect URL)
app.get('/api/auth/activate', async (req, res) => {
  try {
    console.log('üîó Activation endpoint called:', {
      query: req.query,
      url: req.url,
      fullUrl: req.protocol + '://' + req.get('host') + req.originalUrl,
      method: req.method,
      headers: req.headers,
      referer: req.headers.referer || 'no referer'
    });
    
    const { token_hash, type, token, code, email } = req.query;
    const frontendUrl = process.env.FRONTEND_URL || 'https://svag.vercel.app';
    
    // ‚≠ê KL√çƒåOV√â: Pokud Supabase redirectuje bez parametr≈Ø (u≈æ token ovƒõ≈ôil na sv√©m serveru)
    // Supabase ovƒõ≈ôuje token na /auth/v1/verify a pak redirectuje bez parametr≈Ø
    // V tomto p≈ô√≠padƒõ je u≈æivatel u≈æ aktivn√≠, staƒç√≠ zobrazit success str√°nku
    if (!token_hash && !token && !code && !email) {
      console.log('‚ö†Ô∏è No query parameters - Supabase already verified token on their server');
      console.log('üí° User account is already activated by Supabase');
      console.log('üí° Redirecting to success page - user can login with email');
      
      // Redirect na success str√°nku
      const redirectUrl = `${frontendUrl}/activate?success=true&message=activated`;
      console.log('üîÑ Redirecting to:', redirectUrl);
      return res.redirect(redirectUrl);
    }
    
    // ‚≠ê ALTERNATIVA: Pokud je referer, zkusit z√≠skat token z referer URL
    if (!token_hash && !token && !code && req.headers.referer) {
      console.log('‚ö†Ô∏è No query parameters - checking referer URL for token');
      try {
        const refererUrl = new URL(req.headers.referer);
        const refererToken = refererUrl.searchParams.get('token');
        const refererType = refererUrl.searchParams.get('type');
        
        console.log('üìã Referer URL params:', {
          token: refererToken ? 'present' : 'missing',
          type: refererType || 'missing',
          fullReferer: req.headers.referer.substring(0, 100) + '...'
        });
        
        if (refererToken && refererType === 'signup') {
          console.log('‚úÖ Found token in referer URL, processing...');
          // Pou≈æ√≠t token z referer
          try {
            const { data, error } = await supabase.auth.verifyOtp({
              token: refererToken,
              type: 'signup'
            });
            
            if (!error && data && data.user) {
              console.log('‚úÖ User activated successfully from referer token:', {
                userId: data.user.id,
                email: data.user.email,
                hasSession: !!data.session
              });
              
              await createUserProfileIfNeeded(data.user.id, data.user.email);
              
              const redirectUrl = `${frontendUrl}/activate?success=true&token=${data.session.access_token}`;
              console.log('üîÑ Redirecting to:', redirectUrl);
              return res.redirect(redirectUrl);
            } else {
              console.error('‚ùå verifyOtp error with referer token:', error);
            }
          } catch (err) {
            console.error('‚ùå Exception processing referer token:', err);
          }
        }
      } catch (refererErr) {
        console.error('‚ùå Error parsing referer URL:', refererErr);
        // Pokud se nepoda≈ôilo parsovat referer, pokraƒçovat d√°l
      }
    }
    
    // Supabase m≈Ø≈æe poslat r≈Øzn√© parametry v z√°vislosti na typu
    console.log('üìã Query parameters:', {
      token_hash: token_hash ? 'present' : 'missing',
      type: type || 'missing',
      token: token ? 'present' : 'missing',
      code: code ? 'present' : 'missing',
      email: email ? 'present' : 'missing'
    });
    
    // 1. SIGNUP - zkusit s token_hash (standardn√≠ zp≈Øsob)
    if (type === 'signup') {
      console.log('‚úÖ Processing signup activation');
      
      if (token_hash) {
        console.log('üìã Trying signup with token_hash');
        try {
          const { data, error } = await supabase.auth.verifyOtp({
            token_hash,
            type: 'signup'
          });
          
          if (!error && data && data.user) {
            console.log('‚úÖ User activated successfully with token_hash:', {
              userId: data.user.id,
              email: data.user.email,
              hasSession: !!data.session
            });
            
            // Vytvo≈ôit user profile pokud neexistuje
            await createUserProfileIfNeeded(data.user.id, data.user.email);
            
            // Redirect na √∫spƒõ≈°nou str√°nku
            const redirectUrl = `${frontendUrl}/activate?success=true&token=${data.session.access_token}`;
            console.log('üîÑ Redirecting to:', redirectUrl);
            return res.redirect(redirectUrl);
          } else {
            console.error('‚ùå verifyOtp error with token_hash:', error);
          }
        } catch (err) {
          console.error('‚ùå Exception with token_hash:', err);
        }
      }
      
      // 2. SIGNUP - zkusit s token (alternativn√≠ zp≈Øsob, kdy≈æ Supabase pos√≠l√° token m√≠sto token_hash)
      if (token && !token_hash) {
        console.log('üìã Trying signup with token (alternative)');
        try {
          const { data, error } = await supabase.auth.verifyOtp({
            token,
            type: 'signup'
          });
          
          if (!error && data && data.user) {
            console.log('‚úÖ User activated successfully with token:', {
              userId: data.user.id,
              email: data.user.email,
              hasSession: !!data.session
            });
            
            // Vytvo≈ôit user profile pokud neexistuje
            await createUserProfileIfNeeded(data.user.id, data.user.email);
            
            // Redirect na √∫spƒõ≈°nou str√°nku
            const redirectUrl = `${frontendUrl}/activate?success=true&token=${data.session.access_token}`;
            console.log('üîÑ Redirecting to:', redirectUrl);
            return res.redirect(redirectUrl);
          } else {
            console.error('‚ùå verifyOtp error with token:', error);
          }
        } catch (err) {
          console.error('‚ùå Exception with token:', err);
        }
      }
      
      // Pokud ≈æ√°dn√Ω zp≈Øsob nefungoval pro signup
      console.warn('‚ö†Ô∏è Could not verify signup with provided parameters');
      return res.redirect(`${frontendUrl}/activate?error=invalid`);
    }
    
    // 3. MAGICLINK - pro existuj√≠c√≠ u≈æivatele
    if (type === 'magiclink' && token) {
      console.log('‚úÖ Processing magiclink with token');
      try {
        const { data, error } = await supabase.auth.verifyOtp({
          token,
          type: 'magiclink'
        });
        
        if (!error && data && data.user) {
          console.log('‚úÖ Magic link verified:', {
            userId: data.user.id,
            email: data.user.email,
            hasSession: !!data.session
          });
          
          // Vytvo≈ôit user profile pokud neexistuje
          await createUserProfileIfNeeded(data.user.id, data.user.email);
          
          const redirectUrl = `${frontendUrl}/activate?success=true&token=${data.session.access_token}`;
          console.log('üîÑ Redirecting to:', redirectUrl);
          return res.redirect(redirectUrl);
        } else {
          console.error('‚ùå Magic link verification error:', error);
        }
      } catch (err) {
        console.error('‚ùå Magic link verification exception:', err);
      }
    }
    
    // Pokud ≈æ√°dn√Ω z v√Ω≈°e uveden√Ωch zp≈Øsob≈Ø nefunguje, zobrazit chybu
    console.warn('‚ö†Ô∏è Unknown activation parameters:', req.query);
    return res.redirect(`${frontendUrl}/activate?error=invalid`);
  } catch (error) {
    console.error('‚ùå Chyba p≈ôi aktivaci:', {
      message: error.message,
      stack: error.stack,
      name: error.name
    });
    const frontendUrl = process.env.FRONTEND_URL || 'https://svag.vercel.app';
    res.redirect(`${frontendUrl}/activate?error=server`);
  }
});

// ===== GALERIE ENDPOINTY =====

app.post('/api/gallery', authenticate, async (req, res) => {
  try {
    console.log('üîµ POST /api/gallery - Request received');
    console.log('üìß User:', req.user?.email, 'ID:', req.user?.id);
    
    const { svg, source, name, size } = req.body;
    console.log('üì¶ Request data:', { 
      svgLength: svg?.length, 
      source, 
      name, 
      size 
    });
    
    if (!svg) {
      console.log('‚ùå No SVG content provided');
      return res.status(400).json({ error: 'SVG content is required' });
    }
    
    // Zkontrolovat limit
    console.log('üîç Checking icon count for user...');
    const { count, error: countError } = await supabaseAdmin
      .from('svg_icons')
      .select('*', { count: 'exact', head: true })
      .eq('user_id', req.user.id);
    
    if (countError) {
      console.error('‚ùå Error counting icons:', countError);
      return res.status(500).json({ error: 'Failed to check icon count' });
    }
    console.log('‚úÖ Current icon count:', count);
    
    console.log('üîç Checking user profile...');
    console.log('üîç Query params:', { userId: req.user.id });
    
    let profile, profileError;
    try {
      const result = await supabaseAdmin
        .from('user_profiles')
        .select('icon_limit, tier')
        .eq('id', req.user.id)
        .maybeSingle();
      
      profile = result.data;
      profileError = result.error;
      
      console.log('üìä Profile query completed!');
      console.log('üìä Profile data:', profile);
      console.log('üìä Profile error:', profileError);
      console.log('üìä Has profile?', !!profile);
      console.log('üìä Has error?', !!profileError);
    } catch (queryError) {
      console.error('‚ùå‚ùå‚ùå EXCEPTION in profile query:', queryError);
      console.error('Exception message:', queryError.message);
      console.error('Exception stack:', queryError.stack);
      return res.status(500).json({ error: 'Profile query failed', details: queryError.message });
    }
    
    if (profileError) {
      console.error('‚ùå Error fetching profile:', profileError);
      return res.status(500).json({ error: 'Failed to fetch user profile' });
    }
    
    // Pokud profil neexistuje, vytvo≈ôit ho
    if (!profile) {
      console.log('üìù Creating missing user profile for:', req.user.email);
      const { error: insertError } = await supabaseAdmin.from('user_profiles').insert({
        id: req.user.id,
        email: req.user.email,
        tier: 'free',
        icon_limit: 100,
        subscription_status: 'active'
      });
      
      if (insertError) {
        console.error('‚ùå Error creating profile:', insertError);
        return res.status(500).json({ error: 'Failed to create user profile' });
      }
      
      // Naƒç√≠st novƒõ vytvo≈ôen√Ω profil
      const { data: newProfile } = await supabaseAdmin
        .from('user_profiles')
        .select('icon_limit, tier')
        .eq('id', req.user.id)
        .single();
      
      profile = newProfile;
      console.log('‚úÖ Profile created successfully');
    } else {
      console.log('‚úÖ Profile found:', { tier: profile.tier, limit: profile.icon_limit });
    }
    
    if (count >= profile.icon_limit) {
      return res.status(400).json({ 
        error: 'Icon limit reached',
        current: count,
        limit: profile.icon_limit,
        tier: profile.tier,
        message: profile.tier === 'free' 
          ? 'Upgrade to Pro for 1000 icons!' 
          : 'You have reached your icon limit'
      });
    }
    
    // Extrahovat n√°zev
    let iconName = name || 'Bez n√°zvu';
    if (!name && source) {
      try {
        const url = new URL(source);
        iconName = url.pathname.split('/').pop().replace(/\.(svg|png|jpg|jpeg)$/i, '') || 'Bez n√°zvu';
      } catch {
        iconName = 'Bez n√°zvu';
      }
    }
    
    // Komprese a v√Ωpoƒçet velikost√≠
    console.log('üóúÔ∏è Compressing SVG...');
    const { originalSize, compressedSize, compressedContent } = calculateSizes(svg);
    console.log('‚úÖ Compression done:', { originalSize, compressedSize });
    
    console.log('üíæ Inserting icon into database...');
    const { data, error } = await supabaseAdmin
      .from('svg_icons')
      .insert([
        {
          user_id: req.user.id,
          name: iconName,
          size: originalSize,
          compressed_size: compressedSize,
          source: source || 'unknown',
          svg_content: compressedContent,
          is_compressed: true,
        }
      ])
      .select()
      .single();
    
    if (error) {
      console.error('‚ùå Error inserting icon:', error);
      return res.status(500).json({ error: error.message });
    }
    
    const savingsPercent = ((1 - compressedSize / originalSize) * 100).toFixed(1);
    console.log('‚úÖ SVG p≈ôid√°no (' + originalSize + 'KB -> ' + compressedSize + 'KB, √∫spora ' + savingsPercent + '%): ' + req.user.email);
    res.json({ 
      message: 'Added to gallery', 
      item: data,
      compression_ratio: ((1 - compressedSize / originalSize) * 100).toFixed(1) + '%'
    });
  } catch (error) {
    console.error('‚ùå‚ùå‚ùå FATAL ERROR in POST /api/gallery ‚ùå‚ùå‚ùå');
    console.error('Error message:', error.message);
    console.error('Error name:', error.name);
    console.error('Error stack:', error.stack);
    console.error('User:', req.user?.email);
    res.status(500).json({ 
      error: 'Internal server error',
      message: error.message,
      details: process.env.NODE_ENV === 'development' ? error.stack : undefined
    });
  }
});

app.get('/api/gallery', authenticate, async (req, res) => {
  try {
    const { data, error } = await supabaseAdmin
      .from('svg_icons')
      .select('*')
      .eq('user_id', req.user.id)
      .order('created_at', { ascending: false });
    
    if (error) {
      return res.status(500).json({ error: error.message });
    }
    
    // Dekomprimovat SVG
    const items = data.map(item => ({
      id: item.id,
      svg: item.is_compressed ? decompressSvg(item.svg_content) : item.svg_content,
      source: item.source,
      timestamp: item.created_at,
      name: item.name,
      size: item.size
    }));
    
    res.json(items);
  } catch (error) {
    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ galerie:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

app.get('/api/gallery/stats', authenticate, async (req, res) => {
  try {
    const { count } = await supabaseAdmin
      .from('svg_icons')
      .select('*', { count: 'exact', head: true })
      .eq('user_id', req.user.id);
    
    let { data: profile } = await supabaseAdmin
      .from('user_profiles')
      .select('icon_limit, tier, subscription_status')
      .eq('id', req.user.id)
      .maybeSingle();
    
    // Pokud profil neexistuje, vytvo≈ôit ho
    if (!profile) {
      console.log('üìù Creating missing user profile for:', req.user.email);
      const { error: insertError } = await supabaseAdmin.from('user_profiles').insert({
        id: req.user.id,
        email: req.user.email,
        tier: 'free',
        icon_limit: 100,
        subscription_status: 'active'
      });
      
      if (insertError) {
        console.error('‚ùå Error creating profile:', insertError);
        return res.status(500).json({ error: 'Failed to create user profile' });
      }
      
      // Naƒç√≠st novƒõ vytvo≈ôen√Ω profil
      const { data: newProfile } = await supabaseAdmin
        .from('user_profiles')
        .select('icon_limit, tier, subscription_status')
        .eq('id', req.user.id)
        .single();
      
      profile = newProfile;
    }
    
    res.json({
      current: count,
      limit: profile.icon_limit,
      remaining: profile.icon_limit - count,
      tier: profile.tier,
      subscription_status: profile.subscription_status,
      can_upgrade: profile.tier === 'free'
    });
  } catch (error) {
    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ statistik:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

app.delete('/api/gallery/:id', authenticate, async (req, res) => {
  try {
    const { error } = await supabaseAdmin
      .from('svg_icons')
      .delete()
      .eq('id', req.params.id)
      .eq('user_id', req.user.id);
    
    if (error) {
      return res.status(500).json({ error: error.message });
    }
    
    console.log('‚úÖ SVG smaz√°no: ' + req.user.email);
    res.json({ message: 'Deleted from gallery' });
  } catch (error) {
    console.error('Chyba p≈ôi maz√°n√≠:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// ===== STRIPE BILLING ENDPOINTY =====

app.get('/api/pricing', (req, res) => {
  res.json(PRICING);
});

app.post('/api/create-checkout-session', authenticate, async (req, res) => {
  try {
    const { data: profile } = await supabase
      .from('user_profiles')
      .select('stripe_customer_id, tier')
      .eq('id', req.user.id)
      .single();
    
    if (profile.tier === 'pro') {
      return res.status(400).json({ error: 'Already subscribed to Pro' });
    }
    
    // Vytvo≈ôit nebo pou≈æ√≠t existuj√≠c√≠ho Stripe z√°kazn√≠ka
    let customerId = profile.stripe_customer_id;
    
    if (!customerId) {
      const customer = await stripe.customers.create({
        email: req.user.email,
        metadata: {
          supabase_user_id: req.user.id
        }
      });
      customerId = customer.id;
      
      await supabaseAdmin
        .from('user_profiles')
        .update({ stripe_customer_id: customerId })
        .eq('id', req.user.id);
    }
    
    // Vytvo≈ôit Checkout Session
    const session = await stripe.checkout.sessions.create({
      customer: customerId,
      payment_method_types: ['card'],
      line_items: [
        {
          price: PRICING.pro.price_id,
          quantity: 1,
        },
      ],
      mode: 'subscription',
      success_url: `${process.env.FRONTEND_URL || 'http://localhost:3000'}/gallery?success=true`,
      cancel_url: `${process.env.FRONTEND_URL || 'http://localhost:3000'}/gallery?canceled=true`,
      metadata: {
        supabase_user_id: req.user.id
      }
    });
    
    res.json({ sessionId: session.id, url: session.url });
  } catch (error) {
    console.error('Chyba p≈ôi vytv√°≈ôen√≠ checkout session:', error);
    res.status(500).json({ error: error.message });
  }
});

app.post('/api/cancel-subscription', authenticate, async (req, res) => {
  try {
    const { data: profile } = await supabase
      .from('user_profiles')
      .select('stripe_subscription_id')
      .eq('id', req.user.id)
      .single();
    
    if (!profile.stripe_subscription_id) {
      return res.status(400).json({ error: 'No active subscription' });
    }
    
    await stripe.subscriptions.update(profile.stripe_subscription_id, {
      cancel_at_period_end: true
    });
    
    res.json({ message: 'Subscription will be canceled at period end' });
  } catch (error) {
    console.error('Chyba p≈ôi ru≈°en√≠ subscription:', error);
    res.status(500).json({ error: error.message });
  }
});

// Stripe Webhook
app.post('/api/webhooks/stripe', async (req, res) => {
  const sig = req.headers['stripe-signature'];
  let event;
  
  try {
    event = stripe.webhooks.constructEvent(req.body, sig, STRIPE_WEBHOOK_SECRET);
  } catch (err) {
    console.error('‚ùå Webhook signature verification failed:', err.message);
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }
  
  console.log(`üìß Stripe webhook received: ${event.type}`);
  
  try {
    switch (event.type) {
      case 'checkout.session.completed': {
        const session = event.data.object;
        const userId = session.metadata.supabase_user_id;
        
        await supabaseAdmin
          .from('user_profiles')
          .update({ 
            tier: 'pro',
            icon_limit: 1000,
            stripe_subscription_id: session.subscription,
            subscription_status: 'active'
          })
          .eq('id', userId);
        
        console.log(`‚úÖ User upgraded to Pro: ${userId}`);
        break;
      }
      
      case 'customer.subscription.updated': {
        const subscription = event.data.object;
        const customerId = subscription.customer;
        
        const { data: profile } = await supabaseAdmin
          .from('user_profiles')
          .select('id')
          .eq('stripe_customer_id', customerId)
          .single();
        
        if (profile) {
          await supabaseAdmin
            .from('user_profiles')
            .update({ 
              subscription_status: subscription.status,
              subscription_current_period_end: new Date(subscription.current_period_end * 1000)
            })
            .eq('id', profile.id);
          
          console.log(`‚úÖ Subscription updated: ${profile.id}`);
        }
        break;
      }
      
      case 'customer.subscription.deleted': {
        const subscription = event.data.object;
        const customerId = subscription.customer;
        
        const { data: profile } = await supabaseAdmin
          .from('user_profiles')
          .select('id')
          .eq('stripe_customer_id', customerId)
          .single();
        
        if (profile) {
          await supabaseAdmin
            .from('user_profiles')
            .update({ 
              tier: 'free',
              icon_limit: 100,
              subscription_status: 'canceled',
              stripe_subscription_id: null
            })
            .eq('id', profile.id);
          
          console.log(`‚ö†Ô∏è User downgraded to Free: ${profile.id}`);
        }
        break;
      }
      
      case 'invoice.payment_succeeded': {
        const invoice = event.data.object;
        const customerId = invoice.customer;
        
        const { data: profile } = await supabaseAdmin
          .from('user_profiles')
          .select('id')
          .eq('stripe_customer_id', customerId)
          .single();
        
        if (profile) {
          await supabaseAdmin
            .from('payment_history')
            .insert({
              user_id: profile.id,
              stripe_payment_intent_id: invoice.payment_intent,
              amount: invoice.amount_paid / 100,
              currency: invoice.currency,
              status: 'succeeded'
            });
          
          console.log(`üí∞ Payment recorded: ${profile.id}`);
        }
        break;
      }
      
      case 'invoice.payment_failed': {
        const invoice = event.data.object;
        const customerId = invoice.customer;
        
        const { data: profile } = await supabaseAdmin
          .from('user_profiles')
          .select('id')
          .eq('stripe_customer_id', customerId)
          .single();
        
        if (profile) {
          await supabaseAdmin
            .from('user_profiles')
            .update({ subscription_status: 'past_due' })
            .eq('id', profile.id);
          
          console.log(`‚ö†Ô∏è Payment failed: ${profile.id}`);
        }
        break;
      }
    }
    
    res.json({ received: true });
  } catch (error) {
    console.error('‚ùå Error processing webhook:', error);
    res.status(500).json({ error: 'Webhook processing failed' });
  }
});

// ===== ADMIN ENDPOINTY =====

app.get('/api/admin/users', authenticateAdmin, async (req, res) => {
  try {
    const { data: { users }, error: authError } = await supabaseAdmin.auth.admin.listUsers();
    
    if (authError) {
      return res.status(500).json({ error: authError.message });
    }
    
    const userIds = users.map(u => u.id);
    
    const { data: profiles } = await supabaseAdmin
      .from('user_profiles')
      .select('*')
      .in('id', userIds);
    
    const userStats = await Promise.all(
      users.map(async (user) => {
        const { count } = await supabaseAdmin
          .from('svg_icons')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', user.id);
        
        const profile = profiles.find(p => p.id === user.id);
        
        return {
          id: user.id,
          email: user.email,
          created_at: user.created_at,
          icon_count: count || 0,
          icon_limit: profile?.icon_limit || 100,
          tier: profile?.tier || 'free',
          subscription_status: profile?.subscription_status,
          is_admin: profile?.is_admin || false
        };
      })
    );
    
    res.json(userStats);
  } catch (error) {
    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ u≈æivatel≈Ø:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

app.put('/api/admin/users/:id/limit', authenticateAdmin, async (req, res) => {
  try {
    const { limit } = req.body;
    
    if (!limit || limit < 0) {
      return res.status(400).json({ error: 'Invalid limit' });
    }
    
    const { error } = await supabaseAdmin
      .from('user_profiles')
      .update({ icon_limit: limit })
      .eq('id', req.params.id);
    
    if (error) {
      return res.status(500).json({ error: error.message });
    }
    
    console.log(`‚úÖ Limit updated for user: ${req.params.id}`);
    res.json({ message: 'Limit updated' });
  } catch (error) {
    console.error('Chyba p≈ôi aktualizaci limitu:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

app.delete('/api/admin/users/:id', authenticateAdmin, async (req, res) => {
  try {
    const { error } = await supabaseAdmin.auth.admin.deleteUser(req.params.id);
    
    if (error) {
      return res.status(500).json({ error: error.message });
    }
    
    console.log(`‚úÖ U≈æivatel smaz√°n adminem: ${req.params.id}`);
    res.json({ message: 'User deleted' });
  } catch (error) {
    console.error('Chyba p≈ôi maz√°n√≠ u≈æivatele:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

app.get('/api/admin/stats', authenticateAdmin, async (req, res) => {
  try {
    const { data: { users } } = await supabaseAdmin.auth.admin.listUsers();
    const { count: iconCount } = await supabaseAdmin
      .from('svg_icons')
      .select('*', { count: 'exact', head: true });
    
    const { data: profiles } = await supabaseAdmin
      .from('user_profiles')
      .select('tier');
    
    const freeUsers = profiles.filter(p => p.tier === 'free').length;
    const proUsers = profiles.filter(p => p.tier === 'pro').length;
    
    res.json({
      total_users: users.length,
      free_users: freeUsers,
      pro_users: proUsers,
      total_icons: iconCount,
      avg_icons_per_user: (iconCount / users.length).toFixed(1),
      monthly_revenue: proUsers * 9.99
    });
  } catch (error) {
    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ statistik:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// ===== HTML STR√ÅNKY =====

// Serv√≠rovat statick√© soubory z Gallery slo≈æky
app.use('/Gallery', express.static('Gallery'));

// Root page - Landing page
app.get('/', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html lang="cs">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>SVG Galerie - SVAG</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        }
        .container {
          background: white;
          border-radius: 16px;
          padding: 60px 40px;
          max-width: 500px;
          width: 100%;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          text-align: center;
        }
        h1 {
          color: #667eea;
          margin-bottom: 20px;
          font-size: 36px;
        }
        p {
          color: #666;
          line-height: 1.8;
          margin-bottom: 15px;
          font-size: 16px;
        }
        .emoji {
          font-size: 64px;
          margin-bottom: 20px;
        }
        .info-box {
          background: #f5f5f5;
          padding: 20px;
          border-radius: 8px;
          margin: 30px 0;
          text-align: left;
        }
        .info-box h3 {
          color: #764ba2;
          margin-bottom: 15px;
          font-size: 18px;
        }
        .info-box ul {
          list-style: none;
          padding: 0;
        }
        .info-box li {
          padding: 8px 0;
          color: #555;
        }
        .info-box li:before {
          content: "‚úì ";
          color: #667eea;
          font-weight: bold;
          margin-right: 8px;
        }
        .btn {
          display: inline-block;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 14px 32px;
          border-radius: 8px;
          text-decoration: none;
          font-weight: 600;
          font-size: 16px;
          margin: 10px;
          transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary {
          background: #f0f0f0;
          color: #333;
        }
        .btn-secondary:hover {
          background: #e0e0e0;
          box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .note {
          font-size: 14px;
          color: #999;
          margin-top: 30px;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="emoji">üé®</div>
        <h1>SVG Galerie</h1>
        <p>V√≠tejte v SVAG - n√°stroji pro spr√°vu SVG ikon!</p>
        
        <div class="info-box">
          <h3>Jak pou≈æ√≠vat SVAG:</h3>
          <ul>
            <li>Nainstalujte Chrome Extension</li>
            <li>Na jak√©koliv str√°nce: Cmd/Ctrl + hover na SVG ikonu</li>
            <li>Cmd/Ctrl + klik ‚Üí St√°hnout nebo Ulo≈æit do galerie</li>
            <li>Zde spravujte svou kolekci SVG ikon</li>
          </ul>
        </div>
        
        <div class="info-box">
          <h3>Funkce:</h3>
          <ul>
            <li>100 ikon zdarma (Free tier)</li>
            <li>1000 ikon s Pro ($9.99/mƒõs√≠c)</li>
            <li>Automatick√° komprese SVG</li>
            <li>Vyhled√°v√°n√≠ a t≈ô√≠dƒõn√≠</li>
            <li>P≈ô√≠stup odkudkoliv</li>
          </ul>
        </div>
        
        <div style="margin-top: 30px;">
          <a href="https://chrome.google.com/webstore" class="btn" target="_blank">
            Nainstalovat Extension
          </a>
          <a href="/privacy" class="btn btn-secondary">
            Privacy Policy
          </a>
        </div>
        
        <p class="note">
          Pro p≈ô√≠stup k galerii pou≈æijte Chrome Extension.<br>
          API endpoint: <code>/api/gallery</code>
        </p>
      </div>
    </body>
    </html>
  `);
});

// Gallery Login page - P≈ôihla≈°ovac√≠ formul√°≈ô
app.get('/gallery/login', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Login - svag</title>
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: #ffffff;
          min-height: 100vh;
        }
        .login-container {
          width: 100%;
          min-height: 100vh;
        }
        .login-header {
          padding: 48px;
          border-bottom: 1px solid #f0f0f0;
        }
        .login-logo {
          font-size: 48px;
          font-weight: 700;
          letter-spacing: 0.48px;
          color: #070707;
          margin: 0;
        }
        .login-content {
          padding: 0 48px;
          padding-top: 24px;
          max-width: 420px;
        }
        .auth-step {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }
        .login-input {
          width: 100%;
          padding: 18px 24px;
          border: 2px solid #d4d4d4;
          border-radius: 12px;
          font-size: 14px;
          font-family: 'Inter', sans-serif;
          color: #070707;
          transition: border-color 0.2s;
          line-height: 18px;
          letter-spacing: 0.14px;
        }
        .login-input::placeholder {
          color: rgba(0, 0, 0, 0.5);
        }
        .login-input:focus {
          outline: none;
          border-color: #070707;
        }
        .login-btn {
          width: 100%;
          height: 54px;
          padding: 12px;
          background: #000000;
          color: white;
          border: none;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 500;
          cursor: pointer;
          font-family: 'Inter', sans-serif;
          transition: opacity 0.2s;
          line-height: 18px;
          letter-spacing: 0.16px;
        }
        .login-btn:hover {
          opacity: 0.9;
        }
        .login-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }
        .login-btn-secondary {
          width: 100%;
          height: 54px;
          padding: 12px;
          background: #f0f0f0;
          color: #333;
          border: none;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 500;
          cursor: pointer;
          font-family: 'Inter', sans-serif;
          transition: background 0.2s;
        }
        .login-btn-secondary:hover {
          background: #e0e0e0;
        }
        .code-instruction {
          padding: 12px 0;
          font-size: 14px;
          font-weight: 400;
          color: #000000;
          text-align: center;
          line-height: 18px;
          letter-spacing: 0.14px;
          margin: 0;
          max-width: 420px;
        }
        .code-inputs-grid {
          display: flex;
          width: 100%;
          align-items: center;
          gap: 8px;
          justify-content: center;
        }
        .code-input {
          height: 54px;
          flex: 1 0 0;
          width: 100%;
          font-size: 18px;
          font-weight: 600;
          border: 2px solid #d4d4d4;
          border-radius: 12px;
          font-family: 'Inter', sans-serif;
          transition: all 0.2s;
          color: #070707;
          text-align: center;
          padding: 0;
        }
        .code-input:focus {
          outline: none;
          border-color: #070707;
        }
        .code-input.filled {
          border-color: #070707;
        }
        .code-input.error {
          border-color: #f5576c;
          background: #fff0f0;
        }
        .resend-link {
          text-align: center;
          display: block;
          color: rgba(0, 0, 0, 0.5);
          text-decoration: none;
          font-size: 14px;
          padding: 12px 0;
          line-height: 18px;
          letter-spacing: 0.14px;
        }
        .resend-link:hover {
          color: #070707;
        }
        .auth-info,
        .auth-hint {
          text-align: center;
          color: #666;
          font-size: 14px;
          line-height: 1.5;
          padding: 12px 0;
        }
        @media (max-width: 600px) {
          .login-header {
            padding: 24px;
          }
          .login-logo {
            font-size: 36px;
          }
          .login-content {
            padding: 0 24px;
            padding-top: 16px;
          }
          .code-inputs-grid {
            gap: 4px;
          }
          .code-input {
            height: 48px;
            font-size: 18px;
          }
        }
      </style>
    </head>
    <body>
      <div id="loginSection" class="login-container">
        <header class="login-header">
          <h1 class="login-logo">svag</h1>
        </header>
        
        <div class="login-content">
          <!-- Email Step -->
          <div id="emailStep" class="auth-step">
            <input 
              type="email" 
              id="emailInput" 
              class="login-input" 
              placeholder="Start with your mail" 
            />
            <button id="sendBtn" class="login-btn" style="display: none;">Continue</button>
          </div>
          
          <!-- Code Step -->
          <div id="codeStep" class="auth-step" style="display: none;">
            <p class="code-instruction">Check your mailbox and enter the code.</p>
            <div class="code-inputs-grid">
              <input type="text" class="code-input" maxlength="1" data-index="0" />
              <input type="text" class="code-input" maxlength="1" data-index="1" />
              <input type="text" class="code-input" maxlength="1" data-index="2" />
              <input type="text" class="code-input" maxlength="1" data-index="3" />
              <input type="text" class="code-input" maxlength="1" data-index="4" />
              <input type="text" class="code-input" maxlength="1" data-index="5" />
              <input type="text" class="code-input" maxlength="1" data-index="6" />
              <input type="text" class="code-input" maxlength="1" data-index="7" />
            </div>
            <a href="#" id="resendEmailLink" class="resend-link">Resend code</a>
            <button id="verifyCodeBtn" class="login-btn" style="display: none;">Verify</button>
          </div>
          
          <!-- Register Success -->
          <div id="registerSuccess" class="auth-step" style="display: none;">
            <p class="auth-info">Activation link sent to <strong id="registerEmail"></strong></p>
            <p class="auth-hint">Please check your email and click the link to activate your account.</p>
            <button id="backToEmailBtn" class="login-btn-secondary">Back</button>
          </div>
        </div>
      </div>
      
      <script>
        let currentEmail = '';
        const emailInput = document.getElementById('emailInput');
        const sendBtn = document.getElementById('sendBtn');
        const emailStep = document.getElementById('emailStep');
        const codeStep = document.getElementById('codeStep');
        const registerSuccess = document.getElementById('registerSuccess');
        const verifyCodeBtn = document.getElementById('verifyCodeBtn');
        const resendEmailLink = document.getElementById('resendEmailLink');
        const backToEmailBtn = document.getElementById('backToEmailBtn');
        const codeDigits = Array.from(document.querySelectorAll('.code-input'));
        const registerEmailEl = document.getElementById('registerEmail');
        
        // Check if already logged in
        const token = localStorage.getItem('token');
        const userEmail = localStorage.getItem('userEmail');
        if (token && userEmail) {
          window.location.href = '/gallery';
        }
        
        // Email input handlers
        emailInput.addEventListener('focus', () => {
          sendBtn.style.display = 'block';
        });
        
        emailInput.addEventListener('input', () => {
          sendBtn.style.display = emailInput.value.trim() ? 'block' : 'none';
        });
        
        emailInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && emailInput.value.trim()) {
            sendBtn.click();
          }
        });
        
        // Send email
        sendBtn.addEventListener('click', async () => {
          const email = emailInput.value.trim();
          if (!email) {
            alert('Please enter your email');
            return;
          }
          const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;
          if (!emailRegex.test(email)) {
            alert('Please enter a valid email');
            return;
          }
          currentEmail = email;
          try {
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            const response = await fetch('/api/auth/initiate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email })
            });
            const data = await response.json();
            if (response.ok) {
              if (data.type === 'login') {
                showCodeStep();
              } else if (data.type === 'register') {
                showRegisterSuccess(email);
              }
            } else {
              alert(data.error || 'Error sending email');
              sendBtn.disabled = false;
              sendBtn.textContent = 'Continue';
            }
          } catch (error) {
            alert('Connection error');
            sendBtn.disabled = false;
            sendBtn.textContent = 'Continue';
          }
        });
        
        // Code input handlers
        codeDigits.forEach((input, index) => {
          input.addEventListener('input', (e) => {
            clearCodeError();
            const value = e.target.value;
            if (value) {
              input.classList.add('filled');
              if (index < codeDigits.length - 1) {
                codeDigits[index + 1].focus();
              } else {
                verifyCodeBtn.style.display = 'block';
              }
            } else {
              input.classList.remove('filled');
              verifyCodeBtn.style.display = 'none';
            }
          });
          
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !input.value && index > 0) {
              codeDigits[index - 1].focus();
            }
            if (e.key === 'Enter' && verifyCodeBtn.style.display === 'block') {
              verifyCodeBtn.click();
            }
            if (e.key === 'ArrowLeft' && index > 0) {
              codeDigits[index - 1].focus();
            }
            if (e.key === 'ArrowRight' && index < codeDigits.length - 1) {
              codeDigits[index + 1].focus();
            }
          });
          
          input.addEventListener('paste', (e) => {
            e.preventDefault();
            const pasteData = e.clipboardData.getData('text').trim();
            const digits = pasteData.replace(/[^a-zA-Z0-9]/g, '');
            if (digits.length === 8) {
              codeDigits.forEach((digit, i) => {
                digit.value = digits[i] || '';
                digit.classList.add('filled');
              });
              verifyCodeBtn.style.display = 'block';
              codeDigits[codeDigits.length - 1].focus();
            }
          });
        });
        
        // Verify code
        verifyCodeBtn.addEventListener('click', async () => {
          const code = codeDigits.map(d => d.value).join('');
          if (code.length !== 8) {
            alert('Please enter all 8 digits');
            return;
          }
          try {
            verifyCodeBtn.disabled = true;
            verifyCodeBtn.textContent = 'Verifying...';
            const response = await fetch('/api/auth/verify', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                token: code,
                email: currentEmail 
              })
            });
            const data = await response.json();
            if (response.ok && data.token) {
              localStorage.setItem('token', data.token);
              localStorage.setItem('userEmail', currentEmail);
              window.postMessage({
                source: 'svag-gallery',
                action: 'galleryLogin',
                token: data.token,
                email: currentEmail,
                apiUrl: window.location.origin
              }, '*');
              window.location.href = '/gallery';
            } else {
              showCodeError();
              verifyCodeBtn.disabled = false;
              verifyCodeBtn.textContent = 'Verify';
            }
          } catch (error) {
            alert('Verification error');
            verifyCodeBtn.disabled = false;
            verifyCodeBtn.textContent = 'Verify';
          }
        });
        
        // Resend email
        resendEmailLink.addEventListener('click', async (e) => {
          e.preventDefault();
          try {
            resendEmailLink.textContent = 'Sending...';
            await fetch('/api/auth/initiate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: currentEmail })
            });
            resendEmailLink.textContent = 'Sent!';
            setTimeout(() => {
              resendEmailLink.textContent = 'Resend code';
            }, 2000);
          } catch (error) {
            resendEmailLink.textContent = 'Resend code';
          }
        });
        
        // Back to email
        backToEmailBtn.addEventListener('click', () => {
          showLoginForm();
        });
        
        function showCodeStep() {
          emailStep.style.display = 'none';
          registerSuccess.style.display = 'none';
          codeStep.style.display = 'flex';
          codeDigits.forEach(digit => {
            digit.value = '';
            digit.classList.remove('filled', 'error');
          });
          verifyCodeBtn.style.display = 'none';
          verifyCodeBtn.disabled = false;
          verifyCodeBtn.textContent = 'Verify';
          setTimeout(() => codeDigits[0].focus(), 100);
        }
        
        function showRegisterSuccess(email) {
          emailStep.style.display = 'none';
          codeStep.style.display = 'none';
          registerSuccess.style.display = 'flex';
          registerEmailEl.textContent = email;
        }
        
        function showLoginForm() {
          emailStep.style.display = 'flex';
          codeStep.style.display = 'none';
          registerSuccess.style.display = 'none';
          emailInput.value = '';
          sendBtn.style.display = 'none';
          sendBtn.disabled = false;
          sendBtn.textContent = 'Continue';
        }
        
        function showCodeError() {
          codeDigits.forEach(digit => {
            digit.classList.add('error');
          });
          verifyCodeBtn.textContent = 'Wrong code';
          verifyCodeBtn.disabled = true;
        }
        
        function clearCodeError() {
          codeDigits.forEach(digit => {
            digit.classList.remove('error');
          });
          verifyCodeBtn.textContent = 'Verify';
          verifyCodeBtn.disabled = false;
        }
      </script>
    </body>
    </html>
  `);
});

// Gallery page - Kompletn√≠ inline verze (z gallery.ejs + styles.css + script.js)
app.get('/gallery', (req, res) => {
  const stripeKey = process.env.STRIPE_PUBLISHABLE_KEY || 'pk_test_your_key';
  res.send(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>SVG Gallery - svag</title>
      <script src="https://js.stripe.com/v3/"></script>
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
      <style>
        /* Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: #ffffff;
          color: #070707;
          min-height: 100vh;
        }
        
        /* Header */
        .header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 48px;
          border-bottom: 1px solid #f0f0f0;
        }
        
        .logo {
          font-size: 48px;
          font-weight: 700;
          letter-spacing: 0.48px;
          color: #070707;
        }
        
        .header-right {
          display: flex;
          align-items: center;
          gap: 32px;
          font-size: 14px;
          color: rgba(0, 0, 0, 0.5);
        }
        
        .usage-count { font-weight: 400; }
        .user-email { font-weight: 400; }
        
        .logout-btn {
          background: none;
          border: none;
          color: rgba(0, 0, 0, 0.5);
          font-size: 14px;
          font-weight: 400;
          cursor: pointer;
          padding: 0;
          transition: color 0.2s;
          font-family: 'Inter', sans-serif;
        }
        .logout-btn:hover { color: #070707; }
        
        /* Filter Bar */
        .filter-bar {
          display: flex;
          align-items: center;
          gap: 32px;
          padding: 24px 48px;
          border-bottom: 1px solid #f0f0f0;
        }
        
        .filter-btn {
          background: none;
          border: none;
          color: rgba(0, 0, 0, 0.5);
          font-size: 14px;
          font-weight: 400;
          cursor: pointer;
          padding: 0;
          transition: all 0.2s;
          font-family: 'Inter', sans-serif;
          white-space: nowrap;
        }
        .filter-btn:hover { color: #070707; }
        .filter-btn.active { color: #000000; font-weight: 500; }
        
        /* Gallery */
        .gallery-container { padding: 0; }
        
        .gallery {
          display: grid;
          grid-template-columns: repeat(8, 1fr);
          grid-auto-rows: 200px;
          width: 100%;
        }
        
        .gallery-item {
          position: relative;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: background-color 0.2s;
          border: 1px solid transparent;
        }
        .gallery-item:hover { background-color: #f1f1f1; }
        .gallery-item:has(.delete-btn:hover) { background-color: #FFEFEF; }
        
        .gallery-item-inner {
          position: relative;
          width: 36px;
          height: 36px;
        }
        
        .gallery-item svg {
          width: 36px;
          height: 36px;
          display: block;
        }
        
        /* Download Tooltip */
        .download-tooltip {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.9);
          color: white;
          padding: 4px 8px;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 500;
          white-space: nowrap;
          opacity: 0;
          pointer-events: none;
          z-index: 100;
          transition: opacity 0.2s;
        }
        .download-tooltip.show { opacity: 1; }
        
        /* Item Info */
        .item-info {
          position: absolute;
          left: 8px;
          bottom: 8px;
          font-size: 12px;
          color: rgba(0, 0, 0, 0.5);
          opacity: 0;
          transition: opacity 0.2s;
          pointer-events: none;
          z-index: 1;
          white-space: nowrap;
        }
        
        .item-name {
          display: block;
          max-width: 150px;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .item-size {
          position: absolute;
          right: 8px;
          bottom: 8px;
          font-size: 12px;
          color: rgba(0, 0, 0, 0.5);
          opacity: 0;
          transition: opacity 0.2s;
          pointer-events: none;
          z-index: 1;
        }
        
        .item-actions {
          position: absolute;
          top: 8px;
          right: 8px;
          display: flex;
          gap: 8px;
          opacity: 0;
          transition: opacity 0.2s;
          z-index: 2;
        }
        
        .gallery-item:hover .item-info,
        .gallery-item:hover .item-size,
        .gallery-item:hover .item-actions {
          opacity: 1;
        }
        
        .delete-btn {
          background: none;
          border: none;
          color: rgba(0, 0, 0, 0.5);
          font-size: 12px;
          font-weight: 400;
          cursor: pointer;
          transition: color 0.2s;
          font-family: 'Inter', sans-serif;
        }
        .delete-btn:hover { color: #B70202; }
        
        /* Empty State */
        .empty-state {
          text-align: center;
          padding: 100px 48px;
          color: rgba(0, 0, 0, 0.5);
        }
        
        .empty-state h2 {
          font-size: 24px;
          font-weight: 600;
          margin-bottom: 12px;
          color: #070707;
        }
        
        .empty-state p {
          font-size: 14px;
          font-weight: 400;
        }
        
        /* Responsive */
        @media (max-width: 1600px) {
          .gallery { grid-template-columns: repeat(7, 1fr); }
        }
        @media (max-width: 1400px) {
          .gallery { grid-template-columns: repeat(6, 1fr); }
        }
        @media (max-width: 1200px) {
          .header, .filter-bar { padding: 32px; }
          .gallery { grid-template-columns: repeat(5, 1fr); }
        }
        @media (max-width: 900px) {
          .logo { font-size: 36px; }
          .header-right { gap: 16px; font-size: 13px; }
          .filter-bar { gap: 20px; overflow-x: auto; }
          .gallery { grid-template-columns: repeat(4, 1fr); grid-auto-rows: 150px; }
        }
        @media (max-width: 600px) {
          .header { padding: 24px; }
          .user-email { display: none; }
          .filter-bar { padding: 16px 24px; }
          .gallery { grid-template-columns: repeat(3, 1fr); grid-auto-rows: 120px; }
          .gallery-item svg, .gallery-item-inner { width: 28px; height: 28px; }
      </style>
    </head>
    <body>
      <div id="gallerySection">
        <!-- Header -->
        <header class="header">
          <h1 class="logo">svag</h1>
          <div class="header-right">
            <span class="usage-count" id="usageStats">0/100</span>
            <span class="user-email" id="userEmail">Loading...</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
          </div>
        </header>
        
        <!-- Filter Bar -->
        <div class="filter-bar">
          <button class="filter-btn active" data-sort="newest" onclick="sortGallery('newest')">Newest</button>
          <button class="filter-btn" data-sort="oldest" onclick="sortGallery('oldest')">Oldest</button>
          <button class="filter-btn" data-sort="a-z" onclick="sortGallery('a-z')">From A to Z</button>
          <button class="filter-btn" data-sort="z-a" onclick="sortGallery('z-a')">From Z to A</button>
          <button class="filter-btn" data-sort="largest" onclick="sortGallery('largest')">Largest</button>
          <button class="filter-btn" data-sort="smallest" onclick="sortGallery('smallest')">Smallest</button>
        </div>
        
        <!-- Gallery Grid -->
        <div class="gallery-container">
          <div class="gallery" id="gallery"></div>
          <div id="emptyState" class="empty-state" style="display: none;">
            <h2>Nothing here yet</h2>
            <p>Use the Chrome extension to add SVG icons to your gallery</p>
          </div>
        </div>
      </div>
      
      <script>
        const STRIPE_KEY = '${stripeKey}';
        const stripe = Stripe(STRIPE_KEY);
        let token = null;
        let userEmail = null;
        let allItems = [];
        let currentSort = 'newest';
        let userStats = null;
        
        async function init() {
          const urlParams = new URLSearchParams(window.location.search);
          const urlToken = urlParams.get('token');
          const urlEmail = urlParams.get('email');
          
          if (urlToken && urlEmail) {
            localStorage.setItem('token', urlToken);
            localStorage.setItem('userEmail', urlEmail);
            token = urlToken;
            userEmail = urlEmail;
            window.history.replaceState({}, '', '/gallery');
            window.postMessage({
              source: 'svag-gallery',
              action: 'galleryLogin',
              token: token,
              email: userEmail,
              apiUrl: window.location.origin
            }, '*');
          } else {
            token = localStorage.getItem('token');
            userEmail = localStorage.getItem('userEmail');
          }
          
          if (!token || !userEmail) {
            window.location.href = '/gallery/login';
            return;
          }
          
          window.addEventListener('message', (event) => {
            if (event.data && event.data.source === 'svag-extension') {
              if (event.data.action === 'extensionLogin') {
                localStorage.setItem('token', event.data.token);
                localStorage.setItem('userEmail', event.data.email);
                window.location.reload();
              }
              if (event.data.action === 'extensionLogout') {
                localStorage.removeItem('token');
                localStorage.removeItem('userEmail');
                window.location.href = '/gallery/login';
              }
            }
          });
          
          document.getElementById('userEmail').textContent = userEmail;
          await loadGallery();
          await loadStats();
        }
        
        function logout() {
          localStorage.removeItem('token');
          localStorage.removeItem('userEmail');
          window.postMessage({ source: 'svag-gallery', action: 'galleryLogout' }, '*');
          window.location.href = '/gallery/login';
        }
        
        async function loadStats() {
          try {
            const response = await fetch('/api/gallery/stats', {
              headers: { 'Authorization': \`Bearer \${token}\` }
            });
            if (response.ok) {
              userStats = await response.json();
              updateUI();
            }
          } catch (error) {
            console.error('Error loading stats:', error);
          }
        }
        
        function updateUI() {
          if (!userStats) return;
          document.getElementById('usageStats').textContent = \`\${userStats.current}/\${userStats.limit}\`;
        }
        
        async function loadGallery() {
          try {
            const response = await fetch('/api/gallery', {
              headers: { 'Authorization': \`Bearer \${token}\` }
            });
            if (response.ok) {
              allItems = await response.json();
              displayGallery(allItems);
            } else {
              localStorage.removeItem('token');
              localStorage.removeItem('userEmail');
              window.location.href = '/gallery/login';
            }
          } catch (error) {
            alert('Error loading gallery');
          }
        }
        
        function sortGallery(sortType) {
          currentSort = sortType;
          document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
          document.querySelector(\`[data-sort="\${sortType}"]\`).classList.add('active');
          const sorted = [...allItems];
          switch(sortType) {
            case 'newest':
              sorted.sort((a, b) => new Date(b.timestamp || b.created_at) - new Date(a.timestamp || a.created_at));
              break;
            case 'oldest':
              sorted.sort((a, b) => new Date(a.timestamp || a.created_at) - new Date(b.timestamp || b.created_at));
              break;
            case 'a-z':
              sorted.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
              break;
            case 'z-a':
              sorted.sort((a, b) => (b.name || '').localeCompare(a.name || ''));
              break;
            case 'largest':
              sorted.sort((a, b) => parseFloat(b.size || 0) - parseFloat(a.size || 0));
              break;
            case 'smallest':
              sorted.sort((a, b) => parseFloat(a.size || 0) - parseFloat(b.size || 0));
              break;
          }
          displayGallery(sorted);
        }
        
        function isSingleColor(svg) {
          const colors = new Set();
          const fillMatches = svg.match(/fill="([^"]*?)"/gi) || [];
          fillMatches.forEach(match => {
            const color = match.match(/fill="([^"]*?)"/i)?.[1];
            if (color && color !== 'none' && color !== 'transparent' && color !== 'currentColor') {
              colors.add(color.toLowerCase().trim());
            }
          });
          const strokeMatches = svg.match(/stroke="([^"]*?)"/gi) || [];
          strokeMatches.forEach(match => {
            const color = match.match(/stroke="([^"]*?)"/i)?.[1];
            if (color && color !== 'none' && color !== 'transparent' && color !== 'currentColor') {
              colors.add(color.toLowerCase().trim());
            }
          });
          return colors.size <= 1;
        }
        
        function recolorToBlack(svg) {
          return svg
            .replace(/fill="(?!none|transparent)[^"]*"/gi, 'fill="black"')
            .replace(/stroke="(?!none|transparent)[^"]*"/gi, 'stroke="black"')
            .replace(/fill:\\s*(?!none|transparent)[^;"]*/gi, 'fill:black')
            .replace(/stroke:\\s*(?!none|transparent)[^;"]*/gi, 'stroke:black');
        }
        
        function displayGallery(items) {
          const gallery = document.getElementById('gallery');
          const emptyState = document.getElementById('emptyState');
          if (items.length === 0) {
            gallery.style.display = 'none';
            emptyState.style.display = 'block';
            return;
          }
          gallery.style.display = 'grid';
          emptyState.style.display = 'none';
          gallery.innerHTML = items.map(item => {
            const displayName = (item.name || 'icon').length > 20 
              ? (item.name || 'icon').substring(0, 17) + '...'
              : (item.name || 'icon');
            let svg = item.svg;
            if (isSingleColor(svg)) {
              svg = recolorToBlack(svg);
            }
            return \`
              <div class="gallery-item" onclick="downloadItem(event, '\${item.id}')">
                <div class="gallery-item-inner">\${svg}</div>
                <div class="download-tooltip">Downloaded!</div>
                <div class="item-info"><span class="item-name">\${displayName}</span></div>
                <div class="item-size">\${item.size || '0'}kb</div>
                <div class="item-actions">
                  <button class="delete-btn" onclick="deleteItem(event, '\${item.id}')">Delete</button>
                </div>
              </div>
            \`;
          }).join('');
        }
        
        function downloadItem(event, id) {
          if (event) event.stopPropagation();
          const item = allItems.find(i => i.id === id);
          if (!item) return;
          const blob = new Blob([item.svg], { type: 'image/svg+xml' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = \`\${item.name || 'icon'}.svg\`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          const galleryItem = event.currentTarget;
          const tooltip = galleryItem.querySelector('.download-tooltip');
          if (tooltip) {
            tooltip.classList.add('show');
            setTimeout(() => tooltip.classList.remove('show'), 1000);
          }
        }
        
        async function deleteItem(event, id) {
          if (event) event.stopPropagation();
          try {
            const response = await fetch(\`/api/gallery/\${id}\`, {
              method: 'DELETE',
              headers: { 'Authorization': \`Bearer \${token}\` }
            });
            if (response.ok) {
              allItems = allItems.filter(item => item.id !== id);
              sortGallery(currentSort);
              await loadStats();
            } else {
              const error = await response.json();
              alert(error.error || 'Error deleting icon');
            }
          } catch (error) {
            alert('Error deleting icon');
          }
        }
        
        window.addEventListener('DOMContentLoaded', () => {
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.get('success') === 'true') {
            setTimeout(() => {
              alert('‚úÖ Successfully upgraded to Pro!');
              window.history.replaceState({}, document.title, '/gallery');
              if (token) loadStats();
            }, 500);
          }
          if (urlParams.get('canceled') === 'true') {
            setTimeout(() => {
              alert('Payment was canceled.');
              window.history.replaceState({}, document.title, '/gallery');
            }, 500);
          }
        });
        
        init();
      </script>
    </body>
    </html>
  `);
});

// Privacy Policy str√°nka (vy≈æadov√°no pro Chrome Web Store)
app.get('/privacy', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Privacy Policy - SVAG</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          max-width: 800px; 
          margin: 50px auto; 
          padding: 20px;
          line-height: 1.6;
          color: #333;
        }
        h1 { 
          color: #667eea; 
          margin-bottom: 10px;
          font-size: 32px;
        }
        h2 { 
          color: #764ba2; 
          margin-top: 30px;
          margin-bottom: 15px;
          font-size: 24px;
        }
        p { 
          margin-bottom: 15px;
        }
        ul {
          margin: 15px 0;
          padding-left: 30px;
        }
        li {
          margin: 8px 0;
        }
        .last-updated {
          color: #666;
          font-size: 14px;
          margin-bottom: 30px;
        }
        .contact {
          background: #f5f5f5;
          padding: 20px;
          border-radius: 8px;
          margin-top: 30px;
        }
      </style>
    </head>
    <body>
      <h1>Privacy Policy for SVAG</h1>
      <p class="last-updated"><strong>Last updated:</strong> ${new Date().toLocaleDateString('en-US')}</p>
      
      <h2>1. What Data We Collect</h2>
      <p>SVAG collects the following data:</p>
      <ul>
        <li><strong>Email address</strong> - for authentication and communication</li>
        <li><strong>SVG icons</strong> - that you save to your gallery</li>
        <li><strong>Icon source URLs</strong> - to identify the origin of icons</li>
        <li><strong>Usage metadata</strong> - icon count, creation date</li>
        <li><strong>Payment information</strong> - processed exclusively by Stripe, we do not store it</li>
      </ul>
      
      <h2>2. How We Use Your Data</h2>
      <p>We use your data exclusively for:</p>
      <ul>
        <li><strong>Providing the service</strong> - storing and managing SVG icons</li>
        <li><strong>Authentication</strong> - verifying your identity during login</li>
        <li><strong>Payment processing</strong> - managing Pro subscriptions</li>
        <li><strong>Service improvement</strong> - analyzing usage to improve features</li>
      </ul>
      
      <h2>3. Data Sharing</h2>
      <p>We do not share your data with third parties for marketing purposes. Data is only shared with these service providers:</p>
      <ul>
        <li><strong>Supabase</strong> - database hosting and authentication</li>
        <li><strong>Stripe</strong> - payment processing</li>
        <li><strong>Vercel</strong> - application hosting</li>
      </ul>
      <p>All these providers comply with strict security standards and GDPR.</p>
      
      <h2>4. Data Security</h2>
      <p>Your data is protected using:</p>
      <ul>
        <li><strong>SSL/TLS encryption</strong> - for data transmission</li>
        <li><strong>Encrypted storage</strong> - for database data</li>
        <li><strong>Row Level Security (RLS)</strong> - each user sees only their own data</li>
        <li><strong>Regular security audits</strong> - of infrastructure</li>
      </ul>
      
      <h2>5. Your Rights (GDPR)</h2>
      <p>You have the right to:</p>
      <ul>
        <li><strong>Access your data</strong> - you can request a copy of all your data</li>
        <li><strong>Correct your data</strong> - you can correct inaccurate information</li>
        <li><strong>Delete your data</strong> - you can request deletion of all your data</li>
        <li><strong>Export your data</strong> - you can export your icons</li>
        <li><strong>Restrict processing</strong> - you can limit how we use your data</li>
        <li><strong>Data portability</strong> - you can transfer data to another provider</li>
      </ul>
      
      <h2>6. Data Retention</h2>
      <p>We retain your data:</p>
      <ul>
        <li><strong>Active account</strong> - for the duration of service use</li>
        <li><strong>After account deletion</strong> - data is deleted within 30 days</li>
        <li><strong>Payment records</strong> - retained for 7 years (legal requirement)</li>
      </ul>
      
      <h2>7. Cookies and Tracking</h2>
      <p>SVAG uses minimal cookies:</p>
      <ul>
        <li><strong>Authentication token</strong> - to maintain login session</li>
        <li><strong>Local storage</strong> - for Chrome Extension settings</li>
      </ul>
      <p>We do not use third-party tracking cookies or analytics tools.</p>
      
      <h2>8. Children</h2>
      <p>The service is not intended for persons under 16 years of age. We do not knowingly collect personal data from children.</p>
      
      <h2>9. Privacy Policy Changes</h2>
      <p>We will notify you of significant changes by email. Minor changes will be reflected in the "Last updated" date above.</p>
      
      <div class="contact">
        <h2>10. Contact</h2>
        <p>For questions regarding privacy, contact:</p>
        <p><strong>Email:</strong> privacy@svag.app</p>
        <p><strong>Web:</strong> ${process.env.FRONTEND_URL || 'https://svag.vercel.app'}</p>
        <p>We will respond within 48 hours.</p>
      </div>
      
      <p style="margin-top: 40px; font-size: 14px; color: #999;">
        This Privacy Policy complies with GDPR (General Data Protection Regulation) and applicable legislation.
      </p>
    </body>
    </html>
  `);
});

// Admin panel (p≈ôid√°me pozdƒõji pokud bude pot≈ôeba)
app.get('/admin', (req, res) => {
  res.send('<h1>Admin Panel - Coming Soon</h1><p>Pou≈æ√≠vejte Supabase Dashboard pro spr√°vu u≈æivatel≈Ø.</p>');
});

// Health check
app.get('/health', (req, res) => {
  res.json({ 
    status: 'ok',
    timestamp: new Date().toISOString()
  });
});

const PORT = process.env.PORT || 3000;

// Start server pouze pro lok√°ln√≠ development
// Vercel pou≈æ√≠v√° serverless functions, tak≈æe nepot≈ôebuje app.listen()
if (process.env.VERCEL !== '1' && process.env.NODE_ENV !== 'production') {
  app.listen(PORT, () => {
    console.log('');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üé®  svag Backend Server (Supabase + Stripe)');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('');
    console.log(`‚úÖ  Server bƒõ≈æ√≠ na:       http://localhost:${PORT}`);
    console.log(`üñºÔ∏è  Galerie:              http://localhost:${PORT}/gallery`);
    console.log(`üîß  Admin:                http://localhost:${PORT}/admin`);
    console.log(`‚ù§Ô∏è  Health check:         http://localhost:${PORT}/health`);
    console.log('');
    console.log('üí≥  Stripe configured');
    console.log('üóúÔ∏è  SVG compression enabled');
    console.log('üîê  Supabase authenticated');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('');
  });
}

// Export pro Vercel serverless functions
export default app;



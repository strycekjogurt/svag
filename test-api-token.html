<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test API Token - svag v1.2.0</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      margin-top: 0;
      color: #333;
    }
    
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 5px;
    }
    
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #555;
    }
    
    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      box-sizing: border-box;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    button {
      background: #4CAF50;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-right: 10px;
    }
    
    button:hover {
      background: #45a049;
    }
    
    button.secondary {
      background: #2196F3;
    }
    
    button.secondary:hover {
      background: #0b7dda;
    }
    
    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    .result.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    
    .result.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    
    .result.info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    
    .token-info {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Test API Token - svag v1.2.0</h1>
    
    <div class="section">
      <label for="apiUrl">API URL:</label>
      <input type="text" id="apiUrl" value="https://svag.pro/api/gallery" placeholder="https://svag.pro/api/gallery">
    </div>
    
    <div class="section">
      <label for="token">API Token (JWT):</label>
      <textarea id="token" placeholder="Vlo≈æte sem v√°≈° JWT token z chrome.storage.sync..."></textarea>
      <button class="secondary" onclick="loadTokenFromExtension()">üì¶ Naƒç√≠st token z extension</button>
      <button class="secondary" onclick="decodeToken()">üîç Dek√≥dovat token</button>
      <div id="tokenInfo" class="token-info" style="display: none;"></div>
    </div>
    
    <div class="section">
      <label for="svgData">SVG Data (testovac√≠):</label>
      <textarea id="svgData"><?xml version="1.0"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="24" height="24">
  <path fill="#000000" d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
</svg></textarea>
    </div>
    
    <div class="section">
      <label for="iconName">Icon Name:</label>
      <input type="text" id="iconName" value="test-icon" placeholder="test-icon">
    </div>
    
    <div>
      <button onclick="testApiCall()">üöÄ Testovat API vol√°n√≠</button>
      <button class="secondary" onclick="clearResults()">üóëÔ∏è Vymazat v√Ωsledky</button>
    </div>
    
    <div id="result"></div>
  </div>

  <script>
    function log(message, type = 'info') {
      const resultDiv = document.getElementById('result');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `result ${type}`;
      logEntry.textContent = `[${timestamp}] ${message}`;
      resultDiv.appendChild(logEntry);
    }

    async function loadTokenFromExtension() {
      try {
        // Zkontroluj, jestli je chrome.storage dostupn√Ω
        if (typeof chrome === 'undefined' || !chrome.storage) {
          log('‚ö†Ô∏è  chrome.storage nen√≠ dostupn√Ω - tento soubor mus√≠ b√Ωt naƒçten z extension nebo jako extension page', 'error');
          log('üí° ≈òE≈†EN√ç: Zkop√≠rujte token ruƒçnƒõ z Console pomoc√≠:', 'info');
          log('   chrome.storage.sync.get(["apiToken"], (r) => console.log(r.apiToken))', 'info');
          return;
        }
        
        const result = await chrome.storage.sync.get(['apiToken', 'apiUrl', 'refreshToken']);
        
        if (result.apiToken) {
          document.getElementById('token').value = result.apiToken;
          log('‚úÖ Token naƒçten z extension storage', 'success');
          
          if (result.apiUrl) {
            document.getElementById('apiUrl').value = `${result.apiUrl}/api/gallery`;
            log(`üìç API URL nastavena: ${result.apiUrl}`, 'info');
          }
          
          if (result.refreshToken) {
            log('üîÑ Refresh token tak√© dostupn√Ω', 'info');
          }
          
          decodeToken();
        } else {
          log('‚ùå Token nenalezen v extension storage', 'error');
          log('üí° Zkuste se p≈ôihl√°sit v extension popup', 'info');
        }
      } catch (error) {
        log(`‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ tokenu: ${error.message}`, 'error');
        log('üí° ≈òE≈†EN√ç: Zkop√≠rujte token ruƒçnƒõ z Console', 'info');
      }
    }

    function decodeToken() {
      const token = document.getElementById('token').value.trim();
      const infoDiv = document.getElementById('tokenInfo');
      
      if (!token) {
        infoDiv.style.display = 'none';
        return;
      }
      
      try {
        const parts = token.split('.');
        if (parts.length !== 3) {
          throw new Error('Nevalidn√≠ JWT form√°t');
        }
        
        const payload = JSON.parse(atob(parts[1]));
        const exp = new Date(payload.exp * 1000);
        const now = new Date();
        const isExpired = exp < now;
        const timeLeft = ((exp - now) / 1000 / 60).toFixed(1);
        
        infoDiv.innerHTML = `
          <strong>Token Info:</strong><br>
          User ID: ${payload.userId || 'N/A'}<br>
          Email: ${payload.email || 'N/A'}<br>
          Expirace: ${exp.toLocaleString()}<br>
          Status: ${isExpired ? '‚ùå VYPR≈†EL' : `‚úÖ Platn√Ω (${timeLeft} min)`}
        `;
        infoDiv.style.display = 'block';
        
        log(`üîç Token dek√≥dov√°n: ${isExpired ? 'VYPR≈†EL' : `Platn√Ω (${timeLeft} min)`}`, isExpired ? 'error' : 'success');
      } catch (error) {
        infoDiv.innerHTML = `<strong>‚ùå Chyba:</strong> ${error.message}`;
        infoDiv.style.display = 'block';
        log(`‚ùå Chyba p≈ôi dek√≥dov√°n√≠ tokenu: ${error.message}`, 'error');
      }
    }

    async function testApiCall() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      const token = document.getElementById('token').value.trim();
      const svgData = document.getElementById('svgData').value.trim();
      const iconName = document.getElementById('iconName').value.trim();
      
      if (!apiUrl) {
        log('‚ùå API URL je pr√°zdn√°', 'error');
        return;
      }
      
      if (!token) {
        log('‚ùå Token je pr√°zdn√Ω', 'error');
        return;
      }
      
      if (!svgData) {
        log('‚ùå SVG data jsou pr√°zdn√°', 'error');
        return;
      }
      
      log(`üöÄ Odes√≠l√°m request na: ${apiUrl}`, 'info');
      log(`üì¶ Token length: ${token.length} chars`, 'info');
      log(`üì¶ Token preview: ${token.substring(0, 20)}...`, 'info');
      log(`üì¶ SVG size: ${svgData.length} chars`, 'info');
      log(`üì¶ Icon name: ${iconName}`, 'info');
      
      try {
        const requestData = {
          svg: svgData,
          name: iconName
        };
        
        log(`üì§ Request body: ${JSON.stringify(requestData).substring(0, 100)}...`, 'info');
        
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(requestData)
        });
        
        log(`üì• Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
        
        const responseText = await response.text();
        let responseData;
        
        try {
          responseData = JSON.parse(responseText);
        } catch {
          responseData = responseText;
        }
        
        if (response.ok) {
          log(`‚úÖ SUCCESS! Response: ${JSON.stringify(responseData, null, 2)}`, 'success');
        } else {
          log(`‚ùå ERROR ${response.status}: ${JSON.stringify(responseData, null, 2)}`, 'error');
          
          if (response.status === 401) {
            log('üí° TIP: Token je neplatn√Ω nebo vypr≈°el. Zkuste se odhl√°sit a znovu p≈ôihl√°sit v extension popup.', 'error');
          }
        }
        
      } catch (error) {
        log(`‚ùå Fetch error: ${error.message}`, 'error');
        log(`Stack: ${error.stack}`, 'error');
      }
    }

    function clearResults() {
      document.getElementById('result').innerHTML = '';
    }

    // Auto-load token on page load
    window.addEventListener('load', () => {
      log('üîß Test n√°stroj naƒçten.', 'info');
      log('üìã JAK Z√çSKAT TOKEN:', 'info');
      log('   1. Otev≈ôete kteroukoliv str√°nku (nap≈ô. github.com)', 'info');
      log('   2. Stisknƒõte F12 ‚Üí Console', 'info');
      log('   3. Zadejte: chrome.storage.sync.get(["apiToken"], (r) => console.log(r.apiToken))', 'info');
      log('   4. Zkop√≠rujte token a vlo≈æte ho do pole v√Ω≈°e', 'info');
      log('   5. Kliknƒõte na "üîç Dek√≥dovat token" a pak "üöÄ Testovat API vol√°n√≠"', 'info');
    });
  </script>
</body>
</html>

